<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2020-12-23 Wed 00:46 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Python GStreamer Tutorial</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Jens Persson, Ruben Gonzalez, Brett Viren, Vladislav Glinsky">
<meta name="description" content="Rescued by from Internet death by [[https://github.com/rubenrua/GstreamerCodeSnippets][rubenrua]]"
>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="style.css" />
<script type="text/javascript" src="functions.js"></script>

<script type="text/javascript" src="https://orgmode.org/org-info.js">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
// @license-end
</script>

<script type="text/javascript">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
<!--/*--><![CDATA[/*><!--*/
org_html_manager.set("TOC_DEPTH", "2");
org_html_manager.set("LINK_HOME", "https://github.com/brettviren/pygst-tutorial-org");
org_html_manager.set("LINK_UP", ".");
org_html_manager.set("LOCAL_TOC", "above");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "#cccccc");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "1");
org_html_manager.set("VIEW", "showall");
org_html_manager.setup();  // activate after the parameters are set
/*]]>*///-->
// @license-end
</script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="."> UP </a>
 |
 <a accesskey="H" href="https://github.com/brettviren/pygst-tutorial-org"> HOME </a>
</div><div id="content">
<header>
<h1 class="title">Python GStreamer Tutorial</h1>
</header><nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org52fab17">1. Meta</a></li>
<li><a href="#org3b5b63f">2. Introduction</a>
<ul>
<li><a href="#orgc17bbd4">2.1. Command Line</a></li>
</ul>
</li>
<li><a href="#orge2d9e02">3. Playbin</a>
<ul>
<li><a href="#orgd1100c1">3.1. Audio with Playbin</a></li>
<li><a href="#org9815501">3.2. Adding Video</a></li>
</ul>
</li>
<li><a href="#org86e84da">4. Pipeline</a>
<ul>
<li><a href="#org6a31095">4.1. Pipeline Audio Player</a></li>
<li><a href="#orgf4a5f06">4.2. Adding Video to the Pipeline</a></li>
</ul>
</li>
<li><a href="#org3c23bb9">5. Src, sink, pad &#x2026; oh my!</a></li>
<li><a href="#orge6a9d43">6. Seeking</a></li>
<li><a href="#org922ed9a">7. Capabilities</a></li>
<li><a href="#orgff284ff">8. Videomixer</a></li>
<li><a href="#org20414d4">9. Webcam Viewer</a></li>
</ul>
</div>
</nav>
<p>
This tutorial aims at giving a brief introduction to the GStreamer 1.0 multimedia framework using its Python bindings.
</p>

<div id="outline-container-org52fab17" class="outline-2">
<h2 id="org52fab17"><span class="section-number-2">1</span> Meta</h2>
<div class="outline-text-2" id="text-1">
<p>
<a id="org42b8dd9"></a>
</p>

<p>
A GStreamer application is built as a directed, acyclic graph. In the figures these graphs are illustrated with the convention:
</p>

<ul class="org-ul">
<li>right solid line rectangles indicate basic GStreamer <i>elements</i></li>
<li>rounded solid line rectangles to indicate GStreamer <i>bins</i> (and <i>pipelines</i>) subclasses of <i>elements</i>.</li>
<li>rounded dashed line rectangles to indicate <i>pads</i></li>
</ul>

<p>
If you are reading this from a web browser that supports JavaScript you can use some of the built-in features for navigating the document. Click on the "HELP" link or type "<code>?</code>" for instructions on how to use this feature.
</p>
</div>
</div>

<div id="outline-container-org3b5b63f" class="outline-2">
<h2 id="org3b5b63f"><span class="section-number-2">2</span> Introduction</h2>
<div class="outline-text-2" id="text-2">
<p>
<a id="org97f0362"></a>
</p>

<p>
This tutorial is meant to be a quick way to get to know more about GStreamer but it'll take some time to write it though because we don't know it ourselves &#x2026; yet. We're usually using GNU/Linux and GTK in the examples but we try to keep the GUI code to an absolute minimum so it should not get in the way. Just remember that GStreamer depends heavily on Glib so you must make sure that the <a href="https://lazka.github.io/pgi-docs/#GLib-2.0/structs/MainLoop.html">Glib Mainloop</a> is running if you want to catch events on the bus. We take for granted that you are at least a fairly descent Python coder. For problems related to the Python language we redirect you over to <a href="http://python.org/doc">Online Python docs</a>.
</p>

<p>
There are also some example coding distributed with the PyGST source which you may browse at the <a href="https://gitlab.freedesktop.org/gstreamer/gst-python/-/tree/master/examples">gst-python git repository</a>. Reference documents for GStreamer and the rest of the ecosystem it relies on are available at <a href="https://lazka.github.io/pgi-docs/#Gst-1.0">lazka's GitHub site</a>. The main <a href="http://gstreamer.freedesktop.org/">GStreamer</a> site has <a href="https://gstreamer.freedesktop.org/documentation/gstreamer/gi-index.html">Reference Manual</a>, <a href="https://gstreamer.freedesktop.org/documentation/frequently-asked-questions/index.html">FAQ</a>, <a href="https://gstreamer.freedesktop.org/documentation/application-development/index.html">Applications Development Manual</a> and <a href="https://gstreamer.freedesktop.org/documentation/plugin-development/index.html">Plugin Writer's Guide</a>. This tutorial targets the GStreamer 1.0 API which all v1.x releases should follow. The Novacut project has a <a href="https://wiki.ubuntu.com/Novacut/GStreamer1.0">guide to porting</a> Python applications from the prior 0.1 API to 1.0, a little outdated though.
Finally, GStreamer provides a <a href="https://gstreamer.freedesktop.org/documentation/tutorials/index.html">series of tutorials</a> written in C.
</p>

<p>
As you may see this tutorial is far from done and we are always looking for new people to join this project. If you want to write a chapter, fix the examples, provide alternatives or otherwise improve this document please do so. It is suggested to <a href="https://github.com/brettviren/pygst-tutorial-org/">clone the repository on GitHub</a> and issue a pull request. Note, the original source of this document was <a href="http://developer.berlios.de/projects/pygstdocs/">here</a> but is now dead.
</p>
</div>

<div id="outline-container-orgc17bbd4" class="outline-3">
<h3 id="orgc17bbd4"><span class="section-number-3">2.1</span> Command Line</h3>
<div class="outline-text-3" id="text-2-1">
<p>
<a id="org932af14"></a>
</p>

<p>
Before getting started with Python some of the command line interface (CLI) programs that come with GStreamer are explored. Besides being generally useful they can help you find and try out what you need in a very fast and convenient way without writing a bit of code. With <a href="https://gstreamer.freedesktop.org/documentation/tools/gst-inspect.html"><code>gst-inspect</code></a> you can track highlevel elements which are shipped with the various plugins packages.
</p>

<div class="org-src-container">
<pre class="src src-sh">man gst-inspect-1.0
</pre>
</div>

<p>
If you are looking for an element but you don't know its name you can use it with grep. For example, getting the elements that handle mp3 can be done like this:
</p>

<div class="org-src-container">
<pre class="src src-sh">gst-inspect-1.0 | grep mp3 | sort | head -3
</pre>
</div>

<pre class="example">
lame:  lamemp3enc: L.A.M.E. mp3 encoder
libav:  avdec_mp3adufloat: libav ADU (Application Data Unit) MP3 (MPEG audio layer 3) decoder
libav:  avdec_mp3adu: libav ADU (Application Data Unit) MP3 (MPEG audio layer 3) decoder
</pre>


<p>
The <a href="https://gstreamer.freedesktop.org/documentation/playback/playbin.html"><code>playbin</code></a> element is an autoplugger which usually plays anything you throw at it, if you have the appropriate plugins installed.
</p>

<div class="org-src-container">
<pre class="src src-sh">gst-inspect-1.0 playbin &gt; gst-inspect-playbin.txt
</pre>
</div>

<p>
Browse example output <a href="./gst-inspect-playbin.txt">here</a>.
</p>

<p>
You can also run pipelines directly in a terminal with <a href="https://gstreamer.freedesktop.org/documentation/tools/gst-launch.html"><code>gst-launch</code></a>:
</p>

<div class="org-src-container">
<pre class="src src-sh">man gst-launch-1.0
</pre>
</div>

<p>
For playing a file with playbin:
</p>

<div class="org-src-container">
<pre class="src src-sh">gst-launch-1.0 playbin <span style="color: #008000;">\</span>
    <span style="color: #BA36A5;">uri</span>=https://freedesktop.org/software/gstreamer-sdk/data/media/sintel_trailer-480p.webm
</pre>
</div>

<p>
It's also possible to link elements together with "!":
</p>

<div class="org-src-container">
<pre class="src src-sh">gst-launch-1.0 audiotestsrc ! alsasink
</pre>
</div>

<p>
You may also make different streams in the pipeline:
</p>

<div class="org-src-container">
<pre class="src src-sh">gst-launch-1.0 audiotestsrc ! alsasink videotestsrc ! xvimagesink
</pre>
</div>

<p>
Or, you can make a single frame JPEG
</p>

<div class="org-src-container">
<pre class="src src-sh">gst-launch-1.0 videotestsrc num-buffers=1 ! jpegenc <span style="color: #008000;">\</span>
               ! filesink <span style="color: #BA36A5;">location</span>=videotestsrc-frame.jpg
</pre>
</div>


<figure id="org970a4b7">
<img src="./videotestsrc-frame.jpg" alt="videotestsrc-frame.jpg">

</figure>

<p>
If you are using the "name" property you may use the same element more than once. Just put a "." after its name, e.g. with oggmux here.
</p>

<div class="org-src-container">
<pre class="src src-sh">gst-launch-1.0 audiotestsrc ! vorbisenc ! oggmux <span style="color: #BA36A5;">name</span>=mux <span style="color: #008000;">\</span>
               ! filesink <span style="color: #BA36A5;">location</span>=file.ogv videotestsrc ! theoraenc ! mux.
</pre>
</div>

<p>
In the next chapter we will show you more examples with Playbin.
</p>
</div>
</div>
</div>

<div id="outline-container-orge2d9e02" class="outline-2">
<h2 id="orge2d9e02"><span class="section-number-2">3</span> Playbin</h2>
<div class="outline-text-2" id="text-3">
<p>
<a id="orgac69996"></a>
</p>

<p>
The <a href="https://gstreamer.freedesktop.org/documentation/playback/playbin.html"><code>playbin</code></a> element was exercised from the command line in section <a href="#org932af14">2.1</a> and in this section it will be used from Python. It is a high-level, automatic audio and video player. You create a <code>playbin</code> object with:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #0000FF;">import</span> gi
gi.require_version(<span style="color: #008000;">'Gst'</span>, <span style="color: #008000;">'1.0'</span>)
<span style="color: #0000FF;">from</span> gi.repository <span style="color: #0000FF;">import</span> Gst
Gst.init(<span style="color: #D0372D;">None</span>)
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">...</span>
<span style="color: #BA36A5;">my_playbin</span> = Gst.ElementFactory.make(<span style="color: #008000;">"playbin"</span>, <span style="color: #D0372D;">None</span>)
<span style="color: #0000FF;">assert</span> my_playbin
<span style="color: #0000FF;">print</span>(my_playbin)
</pre>
</div>

<pre class="example">
&lt;__gi__.GstPlayBin object at 0x7f74a2d96c80 (GstPlayBin at 0x5594768092c0)&gt;
</pre>


<p>
In order to benefit from handling of GStreamer-specific command line options, pass <code>sys.argv</code> to <a href="https://lazka.github.io/pgi-docs/Gst-1.0/functions.html#Gst.init"><code>Gst.init()</code></a> instead of <code>None</code>. It'll return command line arguments list with recognized <code>--gst-*</code> options removed. Full list of supported options you can get with <code>gst-inspect-1.0 --help-gst</code>. For example, to make debug output more verbose you can pass <code>--gst-debug-level</code> set to <a href="https://gstreamer.freedesktop.org/documentation/tutorials/basic/debugging-tools.html#the-debug-log">higher debug level</a>.
</p>

<p>
To get information about a <code>playbin</code> run:
</p>

<div class="org-src-container">
<pre class="src src-sh">gst-inspect-0.10 playbin
</pre>
</div>

<p>
This figure shows how playbin is built internally. The "optional stuff" are things that could be platform specific or things that you may set with properties.
</p>


<figure id="org9218ea7">
<object type="image/svg+xml" data="playbin-block.svg" class="org-svg">
Sorry, your browser does not support SVG.</object>

</figure>


<p>
The "<b>uri</b>" property should take any possible protocol supported by your GStreamer plugins. One nice feature is that you may switch the sinks out for your own bins as shown below. Playbin always tries to set up the best possible pipeline for your specific environment so if you don't need any special features that are not implemented in playbin, it should in most cases just work "out of the box". Ok, time for a few examples.
</p>
</div>

<div id="outline-container-orgd1100c1" class="outline-3">
<h3 id="orgd1100c1"><span class="section-number-3">3.1</span> Audio with Playbin</h3>
<div class="outline-text-3" id="text-3-1">
<p>
<a id="org08207fc"></a>
</p>

<p>
This first example is just a simple audio player, insert a file with absolute path and it'll play. It's code is listed below. You can run it like:
</p>

<div class="org-src-container">
<pre class="src src-sh">python playbin-example-audio.py
</pre>
</div>

<p>
It will open a small window with a text entry. Enter the full path to some audio file and click "Start".
</p>

<a href="playbin-example-audio.py">playbin-example-audio.py</a>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">!/usr/bin/env python</span>

<span style="color: #0000FF;">import</span> os
<span style="color: #0000FF;">import</span> sys
<span style="color: #0000FF;">import</span> gi

gi.require_version(<span style="color: #008000;">"Gst"</span>, <span style="color: #008000;">"1.0"</span>)
gi.require_version(<span style="color: #008000;">"Gtk"</span>, <span style="color: #008000;">"3.0"</span>)

<span style="color: #0000FF;">from</span> gi.repository <span style="color: #0000FF;">import</span> Gst, Gtk  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">noqa: E402</span>


<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">GTK_Main</span>(<span style="color: #006FE0;">object</span>):
    <span style="color: #0000FF;">def</span> <span style="color: #006699;">__init__</span>(<span style="color: #0000FF;">self</span>):
        <span style="color: #BA36A5;">window</span> = Gtk.Window(<span style="color: #006FE0;">type</span>=Gtk.WindowType.TOPLEVEL)
        window.set_title(<span style="color: #008000;">"Audio-Player"</span>)
        window.set_default_size(300, -1)
        window.connect(<span style="color: #008000;">"destroy"</span>, Gtk.main_quit, <span style="color: #008000;">"WM destroy"</span>)
        <span style="color: #BA36A5;">vbox</span> = Gtk.VBox()
        window.add(vbox)
        <span style="color: #0000FF;">self</span>.entry = Gtk.Entry()
        vbox.pack_start(<span style="color: #0000FF;">self</span>.entry, <span style="color: #D0372D;">False</span>, <span style="color: #D0372D;">True</span>, 0)
        <span style="color: #0000FF;">self</span>.button = Gtk.Button(label=<span style="color: #008000;">"Start"</span>)
        <span style="color: #0000FF;">self</span>.button.connect(<span style="color: #008000;">"clicked"</span>, <span style="color: #0000FF;">self</span>.start_stop)
        vbox.add(<span style="color: #0000FF;">self</span>.button)
        window.show_all()

        <span style="color: #0000FF;">self</span>.player = Gst.ElementFactory.make(<span style="color: #008000;">"playbin"</span>, <span style="color: #008000;">"player"</span>)
        <span style="color: #BA36A5;">fakesink</span> = Gst.ElementFactory.make(<span style="color: #008000;">"fakesink"</span>, <span style="color: #008000;">"fakesink"</span>)
        <span style="color: #0000FF;">self</span>.player.set_property(<span style="color: #008000;">"video-sink"</span>, fakesink)

        <span style="color: #BA36A5;">bus</span> = <span style="color: #0000FF;">self</span>.player.get_bus()
        bus.add_signal_watch()
        bus.connect(<span style="color: #008000;">"message"</span>, <span style="color: #0000FF;">self</span>.on_message)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">start_stop</span>(<span style="color: #0000FF;">self</span>, w):
        <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">self</span>.button.get_label() == <span style="color: #008000;">"Start"</span>:
            <span style="color: #BA36A5;">filepath</span> = <span style="color: #0000FF;">self</span>.entry.get_text().strip()
            <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">not</span> os.path.isfile(filepath):
                <span style="color: #0000FF;">return</span>
            <span style="color: #BA36A5;">filepath</span> = os.path.realpath(filepath)
            <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Stop"</span>)
            <span style="color: #0000FF;">self</span>.player.set_property(<span style="color: #008000;">"uri"</span>, Gst.filename_to_uri(filepath))
            <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.PLAYING)
        <span style="color: #0000FF;">else</span>:
            <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.NULL)
            <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Start"</span>)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">on_message</span>(<span style="color: #0000FF;">self</span>, bus, message):
        <span style="color: #BA36A5;">t</span> = message.<span style="color: #006FE0;">type</span>
        <span style="color: #0000FF;">if</span> t == Gst.MessageType.ERROR:
            <span style="color: #BA36A5;">error_source</span> = message.src.name
            <span style="color: #BA36A5;">err</span>, <span style="color: #BA36A5;">debug</span> = message.parse_error()
            <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Error from '{}':"</span>.<span style="color: #006FE0;">format</span>(error_source), err.message)
            <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Debug info:"</span>, debug)
        <span style="color: #0000FF;">elif</span> t != Gst.MessageType.EOS:
            <span style="color: #0000FF;">return</span>
        <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.NULL)
        <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Start"</span>)


<span style="color: #0000FF;">if</span> <span style="color: #006FE0;">__name__</span> == <span style="color: #008000;">"__main__"</span>:
    Gst.init(sys.argv)
    Gtk.init(sys.argv)
    GTK_Main()
    Gtk.main()
</pre>
</div>
</div>
</div>

<div id="outline-container-org9815501" class="outline-3">
<h3 id="org9815501"><span class="section-number-3">3.2</span> Adding Video</h3>
<div class="outline-text-3" id="text-3-2">
<p>
<a id="org4ec0403"></a>
</p>

<p>
A <code>playbin</code> plugs both audio and video streams automagically and the <code>videosink</code> has been switched out to a <a href="https://gstreamer.freedesktop.org/documentation/coreelements/fakesink.html"><code>fakesink</code></a> element which is GStreamer's answer to directing output to <code>/dev/null</code>. If you want to enable video playback just comment out the following lines:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #BA36A5;">fakesink</span> = Gst.ElementFactory.make(<span style="color: #008000;">"fakesink"</span>, <span style="color: #008000;">"fakesink"</span>)
<span style="color: #0000FF;">self</span>.player.set_property(<span style="color: #008000;">"video-sink"</span>, fakesink)
</pre>
</div>

<p>
If you want to show the video output in a specified window you'll have to use the <a href="https://lazka.github.io/pgi-docs/Gst-1.0/classes/Bus.html#Gst.Bus.enable_sync_message_emission"><code>enable_sync_message_emission()</code></a> method on the bus. Here is an example with the video window embedded in the program.
</p>

<a href="playbin-example-video.py">playbin-example-video.py</a>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">!/usr/bin/env python</span>

<span style="color: #0000FF;">import</span> os
<span style="color: #0000FF;">import</span> sys
<span style="color: #0000FF;">import</span> gi

gi.require_version(<span style="color: #008000;">"Gst"</span>, <span style="color: #008000;">"1.0"</span>)
gi.require_version(<span style="color: #008000;">"GstVideo"</span>, <span style="color: #008000;">"1.0"</span>)
gi.require_version(<span style="color: #008000;">"Gtk"</span>, <span style="color: #008000;">"3.0"</span>)

<span style="color: #0000FF;">from</span> gi.repository <span style="color: #0000FF;">import</span> Gst, Gtk  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">noqa: E402</span>

<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Needed for set_window_handle() to work:</span>
<span style="color: #0000FF;">from</span> gi.repository <span style="color: #0000FF;">import</span> GstVideo  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">noqa: E402, F401</span>


<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">GTK_Main</span>:
    <span style="color: #0000FF;">def</span> <span style="color: #006699;">__init__</span>(<span style="color: #0000FF;">self</span>):
        <span style="color: #BA36A5;">window</span> = Gtk.Window(<span style="color: #006FE0;">type</span>=Gtk.WindowType.TOPLEVEL)
        window.set_title(<span style="color: #008000;">"Video-Player"</span>)
        window.set_default_size(500, 400)
        window.connect(<span style="color: #008000;">"destroy"</span>, Gtk.main_quit, <span style="color: #008000;">"WM destroy"</span>)
        <span style="color: #BA36A5;">vbox</span> = Gtk.VBox()
        window.add(vbox)
        <span style="color: #BA36A5;">hbox</span> = Gtk.HBox()
        vbox.pack_start(hbox, <span style="color: #D0372D;">False</span>, <span style="color: #D0372D;">False</span>, 0)
        <span style="color: #0000FF;">self</span>.entry = Gtk.Entry()
        hbox.add(<span style="color: #0000FF;">self</span>.entry)
        <span style="color: #0000FF;">self</span>.button = Gtk.Button(label=<span style="color: #008000;">"Start"</span>)
        hbox.pack_start(<span style="color: #0000FF;">self</span>.button, <span style="color: #D0372D;">False</span>, <span style="color: #D0372D;">False</span>, 0)
        <span style="color: #0000FF;">self</span>.button.connect(<span style="color: #008000;">"clicked"</span>, <span style="color: #0000FF;">self</span>.start_stop)
        <span style="color: #0000FF;">self</span>.movie_window = Gtk.DrawingArea()
        vbox.add(<span style="color: #0000FF;">self</span>.movie_window)
        window.show_all()

        <span style="color: #0000FF;">self</span>.player = Gst.ElementFactory.make(<span style="color: #008000;">"playbin"</span>, <span style="color: #008000;">"player"</span>)
        <span style="color: #BA36A5;">bus</span> = <span style="color: #0000FF;">self</span>.player.get_bus()
        bus.add_signal_watch()
        bus.enable_sync_message_emission()
        bus.connect(<span style="color: #008000;">"message"</span>, <span style="color: #0000FF;">self</span>.on_message)
        bus.connect(<span style="color: #008000;">"sync-message::element"</span>, <span style="color: #0000FF;">self</span>.on_sync_message)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">start_stop</span>(<span style="color: #0000FF;">self</span>, w):
        <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">self</span>.button.get_label() == <span style="color: #008000;">"Start"</span>:
            <span style="color: #BA36A5;">filepath</span> = <span style="color: #0000FF;">self</span>.entry.get_text().strip()
            <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">not</span> os.path.isfile(filepath):
                <span style="color: #0000FF;">return</span>
            <span style="color: #BA36A5;">filepath</span> = os.path.realpath(filepath)
            <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Stop"</span>)
            <span style="color: #0000FF;">self</span>.player.set_property(<span style="color: #008000;">"uri"</span>, Gst.filename_to_uri(filepath))
            <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.PLAYING)
        <span style="color: #0000FF;">else</span>:
            <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.NULL)
            <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Start"</span>)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">on_message</span>(<span style="color: #0000FF;">self</span>, bus, message):
        <span style="color: #BA36A5;">t</span> = message.<span style="color: #006FE0;">type</span>
        <span style="color: #0000FF;">if</span> t == Gst.MessageType.ERROR:
            <span style="color: #BA36A5;">error_source</span> = message.src.name
            <span style="color: #BA36A5;">err</span>, <span style="color: #BA36A5;">debug</span> = message.parse_error()
            <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Error from '{}':"</span>.<span style="color: #006FE0;">format</span>(error_source), err.message)
            <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Debug info:"</span>, debug)
        <span style="color: #0000FF;">elif</span> t != Gst.MessageType.EOS:
            <span style="color: #0000FF;">return</span>
        <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.NULL)
        <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Start"</span>)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">on_sync_message</span>(<span style="color: #0000FF;">self</span>, bus, message):
        <span style="color: #BA36A5;">message_name</span> = message.get_structure().get_name()
        <span style="color: #0000FF;">if</span> message_name == <span style="color: #008000;">"prepare-window-handle"</span>:
            <span style="color: #BA36A5;">imagesink</span> = message.src
            imagesink.set_property(<span style="color: #008000;">"force-aspect-ratio"</span>, <span style="color: #D0372D;">True</span>)
            <span style="color: #BA36A5;">window_id</span> = <span style="color: #0000FF;">self</span>.movie_window.get_property(<span style="color: #008000;">"window"</span>).get_xid()
            imagesink.set_window_handle(window_id)


<span style="color: #0000FF;">if</span> <span style="color: #006FE0;">__name__</span> == <span style="color: #008000;">"__main__"</span>:
    Gst.init(sys.argv)
    Gtk.init(sys.argv)
    GTK_Main()
    Gtk.main()
</pre>
</div>

<p>
And just to make things a little more complicated you can switch the <code>playbin</code>'s video sink to a <a href="https://lazka.github.io/pgi-docs/Gst-1.0/classes/Bin.html"><code>Gst.Bin</code></a> with a <a href="https://lazka.github.io/pgi-docs/Gst-1.0/classes/GhostPad.html"><code>Gst.GhostPad</code></a> on it. Here's an example with a <a href="https://gstreamer.freedesktop.org/documentation/pango/timeoverlay.html"><code>timeoverlay</code></a>.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #006FE0;">bin</span> = Gst.Bin.new(<span style="color: #008000;">"my-bin"</span>)

<span style="color: #BA36A5;">timeoverlay</span> = Gst.ElementFactory.make(<span style="color: #008000;">"timeoverlay"</span>)
<span style="color: #006FE0;">bin</span>.add(timeoverlay)

<span style="color: #BA36A5;">pad</span> = timeoverlay.get_static_pad(<span style="color: #008000;">"video_sink"</span>)
<span style="color: #BA36A5;">ghostpad</span> = Gst.GhostPad.new(<span style="color: #008000;">"sink"</span>, pad)
<span style="color: #006FE0;">bin</span>.add_pad(ghostpad)

<span style="color: #BA36A5;">videosink</span> = Gst.ElementFactory.make(<span style="color: #008000;">"autovideosink"</span>)
<span style="color: #006FE0;">bin</span>.add(videosink)
timeoverlay.link(videosink)

<span style="color: #0000FF;">self</span>.player.set_property(<span style="color: #008000;">"video-sink"</span>, <span style="color: #006FE0;">bin</span>)
</pre>
</div>

<p>
Add that code to the example above and you'll get a <code>timeoverlay</code> too. We'll talk more about <a href="https://gstreamer.freedesktop.org/documentation/application-development/basics/pads.html#ghost-pads">"ghost pads"</a> <a href="#orga60ce66">later</a>.
</p>

<p>
Here now adds a CLI example which plays music. It can be run it with:
</p>

<div class="org-src-container">
<pre class="src src-sh">python playbin-example-cliplayer.py /path/to/file1.mp3 /path/to/file2.ogg
</pre>
</div>

<a href="playbin-example-cliplayer.py">playbin-example-cliplayer.py</a>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">!/usr/bin/env python</span>

<span style="color: #0000FF;">import</span> os
<span style="color: #0000FF;">import</span> sys
<span style="color: #0000FF;">import</span> gi

gi.require_version(<span style="color: #008000;">"Gst"</span>, <span style="color: #008000;">"1.0"</span>)

<span style="color: #0000FF;">from</span> gi.repository <span style="color: #0000FF;">import</span> Gst, GLib  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">noqa: E402</span>


<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">CLI_Main</span>:
    <span style="color: #0000FF;">def</span> <span style="color: #006699;">__init__</span>(<span style="color: #0000FF;">self</span>, argv):
        <span style="color: #0000FF;">self</span>.player = Gst.ElementFactory.make(<span style="color: #008000;">"playbin"</span>, <span style="color: #008000;">"player"</span>)
        <span style="color: #BA36A5;">fakesink</span> = Gst.ElementFactory.make(<span style="color: #008000;">"fakesink"</span>, <span style="color: #008000;">"fakesink"</span>)
        <span style="color: #0000FF;">self</span>.player.set_property(<span style="color: #008000;">"video-sink"</span>, fakesink)
        <span style="color: #BA36A5;">bus</span> = <span style="color: #0000FF;">self</span>.player.get_bus()
        bus.add_signal_watch()
        bus.connect(<span style="color: #008000;">"message"</span>, <span style="color: #0000FF;">self</span>.on_message)
        <span style="color: #0000FF;">self</span>.loop = GLib.MainLoop()
        <span style="color: #0000FF;">self</span>.playlist = <span style="color: #006FE0;">iter</span>(argv[1:])

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">on_message</span>(<span style="color: #0000FF;">self</span>, bus, message):
        <span style="color: #BA36A5;">t</span> = message.<span style="color: #006FE0;">type</span>
        <span style="color: #0000FF;">if</span> t == Gst.MessageType.ERROR:
            <span style="color: #BA36A5;">error_source</span> = message.src.name
            <span style="color: #BA36A5;">err</span>, <span style="color: #BA36A5;">debug</span> = message.parse_error()
            <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Error from '{}':"</span>.<span style="color: #006FE0;">format</span>(error_source), err.message)
            <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Debug info:"</span>, debug)
        <span style="color: #0000FF;">elif</span> t != Gst.MessageType.EOS:
            <span style="color: #0000FF;">return</span>
        <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.NULL)
        <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">not</span> <span style="color: #0000FF;">self</span>._play_next():
            <span style="color: #0000FF;">self</span>.loop.<span style="color: #D0372D;">quit</span>()

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">_play_next</span>(<span style="color: #0000FF;">self</span>):
        <span style="color: #0000FF;">for</span> filepath <span style="color: #0000FF;">in</span> <span style="color: #0000FF;">self</span>.playlist:
            <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">not</span> os.path.isfile(filepath):
                <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"is not a file:"</span>, filepath)
                <span style="color: #0000FF;">continue</span>
            <span style="color: #BA36A5;">filepath</span> = os.path.realpath(filepath)
            <span style="color: #0000FF;">self</span>.player.set_property(<span style="color: #008000;">"uri"</span>, Gst.filename_to_uri(filepath))
            <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.PLAYING)
            <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"now playing:"</span>, filepath)
            <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">True</span>
        <span style="color: #0000FF;">return</span> <span style="color: #D0372D;">False</span>

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">start</span>(<span style="color: #0000FF;">self</span>):
        <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">self</span>._play_next():
            <span style="color: #0000FF;">self</span>.loop.run()


<span style="color: #0000FF;">if</span> <span style="color: #006FE0;">__name__</span> == <span style="color: #008000;">"__main__"</span>:
    <span style="color: #BA36A5;">args</span> = Gst.init(sys.argv)
    CLI_Main(args).start()
</pre>
</div>

<p>
A <code>playbin</code> implements a <a href="https://lazka.github.io/pgi-docs/Gst-1.0/classes/Pipeline.html"><code>Gst.Pipeline</code></a> element and that's what the next chapter is going to tell you more about.
</p>
</div>
</div>
</div>

<div id="outline-container-org86e84da" class="outline-2">
<h2 id="org86e84da"><span class="section-number-2">4</span> Pipeline</h2>
<div class="outline-text-2" id="text-4">
<p>
<a id="org1c6c7fc"></a>
</p>

<p>
A <a href="https://lazka.github.io/pgi-docs/Gst-1.0/classes/Pipeline.html"><code>Gst.Pipeline</code></a> is a top-level bin with its own bus and clock. If your program only contains one <i>bin</i>-like object, this is what you're looking for. You create a pipeline object with:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #BA36A5;">my_pipeline</span> = Gst.Pipeline.new(<span style="color: #008000;">"my-pipeline"</span>)
</pre>
</div>

<p>
A pipeline is a "container" where you can put other objects and when everything is in place and the file to play is specified you set the pipeline's state to <a href="https://gstreamer.freedesktop.org/documentation/application-development/basics/elements.html#element-states"><code>Gst.State.PLAYING</code></a> and there should be multimedia coming out of it.
</p>
</div>

<div id="outline-container-org6a31095" class="outline-3">
<h3 id="org6a31095"><span class="section-number-3">4.1</span> Pipeline Audio Player</h3>
<div class="outline-text-3" id="text-4-1">
<p>
The first example here starts with the audio player from section <a href="#orgac69996">3</a> and switches the <code>playbin</code> for the <code>mpg123audiodec</code> decoding pipeline that is capable of handling MP3 streams. Before coding it in Python it can be tested using <code>gst-launch</code>.
</p>

<div class="org-src-container">
<pre class="src src-sh">gst-launch-1.0 filesrc <span style="color: #BA36A5;">location</span>=file.mp3 ! mpegaudioparse ! mpg123audiodec <span style="color: #008000;">\</span>
         ! audioconvert ! autoaudiosink
</pre>
</div>

<p>
Conceptually this pipeline looks like:
</p>


<figure id="orga7e2411">
<object type="image/svg+xml" data="pipeline-block.svg" class="org-svg">
Sorry, your browser does not support SVG.</object>

</figure>


<p>
Done in Python this would look like <code>pipeline-example.py</code>:
</p>

<a href="pipeline-example.py">pipeline-example.py</a>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">!/usr/bin/env python</span>

<span style="color: #0000FF;">import</span> sys
<span style="color: #0000FF;">import</span> os
<span style="color: #0000FF;">import</span> gi

gi.require_version(<span style="color: #008000;">"Gst"</span>, <span style="color: #008000;">"1.0"</span>)
gi.require_version(<span style="color: #008000;">"Gtk"</span>, <span style="color: #008000;">"3.0"</span>)

<span style="color: #0000FF;">from</span> gi.repository <span style="color: #0000FF;">import</span> Gst, Gtk  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">noqa: E402</span>


<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">GTK_Main</span>(<span style="color: #006FE0;">object</span>):
    <span style="color: #0000FF;">def</span> <span style="color: #006699;">__init__</span>(<span style="color: #0000FF;">self</span>):
        <span style="color: #BA36A5;">window</span> = Gtk.Window(<span style="color: #006FE0;">type</span>=Gtk.WindowType.TOPLEVEL)
        window.set_title(<span style="color: #008000;">"MP3-Player"</span>)
        window.set_default_size(400, -1)
        window.connect(<span style="color: #008000;">"destroy"</span>, Gtk.main_quit, <span style="color: #008000;">"WM destroy"</span>)
        <span style="color: #BA36A5;">vbox</span> = Gtk.VBox()
        window.add(vbox)
        <span style="color: #0000FF;">self</span>.entry = Gtk.Entry()
        vbox.pack_start(<span style="color: #0000FF;">self</span>.entry, <span style="color: #D0372D;">False</span>, <span style="color: #D0372D;">True</span>, 0)
        <span style="color: #0000FF;">self</span>.button = Gtk.Button(label=<span style="color: #008000;">"Start"</span>)
        <span style="color: #0000FF;">self</span>.button.connect(<span style="color: #008000;">"clicked"</span>, <span style="color: #0000FF;">self</span>.start_stop)
        vbox.add(<span style="color: #0000FF;">self</span>.button)
        window.show_all()

        <span style="color: #0000FF;">self</span>.player = Gst.Pipeline.new(<span style="color: #008000;">"player"</span>)
        <span style="color: #BA36A5;">source</span> = Gst.ElementFactory.make(<span style="color: #008000;">"filesrc"</span>, <span style="color: #008000;">"file-source"</span>)
        <span style="color: #BA36A5;">parse</span> = Gst.ElementFactory.make(<span style="color: #008000;">"mpegaudioparse"</span>, <span style="color: #008000;">"mp3-parse"</span>)
        <span style="color: #BA36A5;">decoder</span> = Gst.ElementFactory.make(<span style="color: #008000;">"mpg123audiodec"</span>, <span style="color: #008000;">"mp3-decoder"</span>)
        <span style="color: #BA36A5;">conv</span> = Gst.ElementFactory.make(<span style="color: #008000;">"audioconvert"</span>, <span style="color: #008000;">"converter"</span>)
        <span style="color: #BA36A5;">sink</span> = Gst.ElementFactory.make(<span style="color: #008000;">"autoaudiosink"</span>, <span style="color: #008000;">"audio-out"</span>)

        <span style="color: #0000FF;">for</span> e <span style="color: #0000FF;">in</span> (source, parse, decoder, conv, sink):
            <span style="color: #0000FF;">self</span>.player.add(e)

        source.link(parse)
        parse.link(decoder)
        decoder.link(conv)
        conv.link(sink)

        <span style="color: #BA36A5;">bus</span> = <span style="color: #0000FF;">self</span>.player.get_bus()
        bus.add_signal_watch()
        bus.connect(<span style="color: #008000;">"message"</span>, <span style="color: #0000FF;">self</span>.on_message)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">start_stop</span>(<span style="color: #0000FF;">self</span>, w):
        <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">self</span>.button.get_label() == <span style="color: #008000;">"Start"</span>:
            <span style="color: #BA36A5;">filepath</span> = <span style="color: #0000FF;">self</span>.entry.get_text().strip()
            <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">not</span> os.path.isfile(filepath):
                <span style="color: #0000FF;">return</span>
            <span style="color: #BA36A5;">filepath</span> = os.path.realpath(filepath)
            <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Stop"</span>)
            <span style="color: #BA36A5;">src</span> = <span style="color: #0000FF;">self</span>.player.get_by_name(<span style="color: #008000;">"file-source"</span>)
            src.set_property(<span style="color: #008000;">"location"</span>, filepath)
            <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.PLAYING)
        <span style="color: #0000FF;">else</span>:
            <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.NULL)
            <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Start"</span>)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">on_message</span>(<span style="color: #0000FF;">self</span>, bus, message):
        <span style="color: #BA36A5;">t</span> = message.<span style="color: #006FE0;">type</span>
        <span style="color: #0000FF;">if</span> t == Gst.MessageType.ERROR:
            <span style="color: #BA36A5;">error_source</span> = message.src.name
            <span style="color: #BA36A5;">err</span>, <span style="color: #BA36A5;">debug</span> = message.parse_error()
            <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Error from '{}':"</span>.<span style="color: #006FE0;">format</span>(error_source), err.message)
            <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Debug info:"</span>, debug)
        <span style="color: #0000FF;">elif</span> t != Gst.MessageType.EOS:
            <span style="color: #0000FF;">return</span>
        <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.NULL)
        <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Start"</span>)


<span style="color: #0000FF;">if</span> <span style="color: #006FE0;">__name__</span> == <span style="color: #008000;">"__main__"</span>:
    Gst.init(sys.argv)
    Gtk.init(sys.argv)
    GTK_Main()
    Gtk.main()
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf4a5f06" class="outline-3">
<h3 id="orgf4a5f06"><span class="section-number-3">4.2</span> Adding Video to the Pipeline</h3>
<div class="outline-text-3" id="text-4-2">
<p>
The next example is playing MPEG2 videos. Some demuxers, such as <code>mpegpsdemux</code>, uses dynamic pads which are created at runtime and therefor you can't link between the demuxer and the next element in the pipeline before the pad has been created at runtime. Watch out for the <code>demuxer_callback()</code> method below.
</p>


<figure id="org771b2a6">
<object type="image/svg+xml" data="pipeline-branch-block.svg" class="org-svg">
Sorry, your browser does not support SVG.</object>

</figure>


<a href="pipeline-branch-example.py">pipeline-branch-example.py</a>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">!/usr/bin/env python</span>

<span style="color: #0000FF;">import</span> os
<span style="color: #0000FF;">import</span> sys
<span style="color: #0000FF;">import</span> gi

gi.require_version(<span style="color: #008000;">"Gst"</span>, <span style="color: #008000;">"1.0"</span>)
gi.require_version(<span style="color: #008000;">"GstVideo"</span>, <span style="color: #008000;">"1.0"</span>)
gi.require_version(<span style="color: #008000;">"Gtk"</span>, <span style="color: #008000;">"3.0"</span>)

<span style="color: #0000FF;">from</span> gi.repository <span style="color: #0000FF;">import</span> Gst, Gtk  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">noqa: E402</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Needed for set_window_handle() to work:</span>
<span style="color: #0000FF;">from</span> gi.repository <span style="color: #0000FF;">import</span> GstVideo      <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">noqa: E402, F401</span>


<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">GTK_Main</span>(<span style="color: #006FE0;">object</span>):
    <span style="color: #0000FF;">def</span> <span style="color: #006699;">__init__</span>(<span style="color: #0000FF;">self</span>):
        <span style="color: #BA36A5;">window</span> = Gtk.Window(<span style="color: #006FE0;">type</span>=Gtk.WindowType.TOPLEVEL)
        window.set_title(<span style="color: #008000;">"Mpeg2-Player"</span>)
        window.set_default_size(500, 400)
        window.connect(<span style="color: #008000;">"destroy"</span>, Gtk.main_quit, <span style="color: #008000;">"WM destroy"</span>)

        <span style="color: #BA36A5;">vbox</span> = Gtk.VBox()
        window.add(vbox)
        <span style="color: #BA36A5;">hbox</span> = Gtk.HBox()
        vbox.pack_start(hbox, <span style="color: #D0372D;">False</span>, <span style="color: #D0372D;">False</span>, 0)
        <span style="color: #0000FF;">self</span>.entry = Gtk.Entry()
        hbox.add(<span style="color: #0000FF;">self</span>.entry)
        <span style="color: #0000FF;">self</span>.button = Gtk.Button(label=<span style="color: #008000;">"Start"</span>)
        hbox.pack_start(<span style="color: #0000FF;">self</span>.button, <span style="color: #D0372D;">False</span>, <span style="color: #D0372D;">False</span>, 0)
        <span style="color: #0000FF;">self</span>.button.connect(<span style="color: #008000;">"clicked"</span>, <span style="color: #0000FF;">self</span>.start_stop)
        <span style="color: #0000FF;">self</span>.movie_window = Gtk.DrawingArea()
        vbox.add(<span style="color: #0000FF;">self</span>.movie_window)
        window.show_all()

        <span style="color: #0000FF;">self</span>.player = Gst.Pipeline.new(<span style="color: #008000;">"player"</span>)
        <span style="color: #BA36A5;">make_element</span> = Gst.ElementFactory.make
        <span style="color: #BA36A5;">source</span> = make_element(<span style="color: #008000;">"filesrc"</span>, <span style="color: #008000;">"file-source"</span>)
        <span style="color: #BA36A5;">demuxer</span> = make_element(<span style="color: #008000;">"mpegpsdemux"</span>, <span style="color: #008000;">"demuxer"</span>)
        demuxer.connect(<span style="color: #008000;">"pad-added"</span>, <span style="color: #0000FF;">self</span>.demuxer_callback)

        <span style="color: #0000FF;">self</span>.queuev = make_element(<span style="color: #008000;">"queue"</span>, <span style="color: #008000;">"queuev"</span>)
        <span style="color: #BA36A5;">video_parser</span> = make_element(<span style="color: #008000;">"mpegvideoparse"</span>, <span style="color: #008000;">"video-parser"</span>)
        <span style="color: #BA36A5;">video_decoder</span> = make_element(<span style="color: #008000;">"mpeg2dec"</span>, <span style="color: #008000;">"video-decoder"</span>)
        <span style="color: #BA36A5;">colorspace</span> = make_element(<span style="color: #008000;">"videoconvert"</span>, <span style="color: #008000;">"colorspace"</span>)
        <span style="color: #BA36A5;">videosink</span> = make_element(<span style="color: #008000;">"autovideosink"</span>, <span style="color: #008000;">"video-output"</span>)

        <span style="color: #0000FF;">self</span>.queuea = make_element(<span style="color: #008000;">"queue"</span>, <span style="color: #008000;">"queuea"</span>)
        <span style="color: #BA36A5;">audio_parser</span> = make_element(<span style="color: #008000;">"mpegaudioparse"</span>, <span style="color: #008000;">"audio-parser"</span>)
        <span style="color: #BA36A5;">audio_decoder</span> = make_element(<span style="color: #008000;">"mpg123audiodec"</span>, <span style="color: #008000;">"audio-decoder"</span>)
        <span style="color: #BA36A5;">audioconv</span> = make_element(<span style="color: #008000;">"audioconvert"</span>, <span style="color: #008000;">"audio-converter"</span>)
        <span style="color: #BA36A5;">audiosink</span> = make_element(<span style="color: #008000;">"autoaudiosink"</span>, <span style="color: #008000;">"audio-output"</span>)

        <span style="color: #0000FF;">for</span> e <span style="color: #0000FF;">in</span> (
            source, demuxer,
            <span style="color: #0000FF;">self</span>.queuev, video_parser, video_decoder, colorspace, videosink,
            <span style="color: #0000FF;">self</span>.queuea, audio_parser, audio_decoder, audioconv, audiosink
        ):
            <span style="color: #0000FF;">self</span>.player.add(e)

        source.link(demuxer)

        <span style="color: #0000FF;">self</span>.queuev.link(video_parser)
        video_parser.link(video_decoder)
        video_decoder.link(colorspace)
        colorspace.link(videosink)

        <span style="color: #0000FF;">self</span>.queuea.link(audio_parser)
        audio_parser.link(audio_decoder)
        audio_decoder.link(audioconv)
        audioconv.link(audiosink)

        <span style="color: #BA36A5;">bus</span> = <span style="color: #0000FF;">self</span>.player.get_bus()
        bus.add_signal_watch()
        bus.enable_sync_message_emission()
        bus.connect(<span style="color: #008000;">"message"</span>, <span style="color: #0000FF;">self</span>.on_message)
        bus.connect(<span style="color: #008000;">"sync-message::element"</span>, <span style="color: #0000FF;">self</span>.on_sync_message)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">start_stop</span>(<span style="color: #0000FF;">self</span>, w):
        <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">self</span>.button.get_label() == <span style="color: #008000;">"Start"</span>:
            <span style="color: #BA36A5;">filepath</span> = <span style="color: #0000FF;">self</span>.entry.get_text().strip()
            <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">not</span> os.path.isfile(filepath):
                <span style="color: #0000FF;">return</span>
            <span style="color: #BA36A5;">filepath</span> = os.path.realpath(filepath)
            <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Stop"</span>)
            <span style="color: #BA36A5;">src</span> = <span style="color: #0000FF;">self</span>.player.get_by_name(<span style="color: #008000;">"file-source"</span>)
            src.set_property(<span style="color: #008000;">"location"</span>, filepath)
            <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.PLAYING)
        <span style="color: #0000FF;">else</span>:
            <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.NULL)
            <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Start"</span>)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">on_message</span>(<span style="color: #0000FF;">self</span>, bus, message):
        <span style="color: #BA36A5;">t</span> = message.<span style="color: #006FE0;">type</span>
        <span style="color: #0000FF;">if</span> t == Gst.MessageType.ERROR:
            <span style="color: #BA36A5;">error_source</span> = message.src.name
            <span style="color: #BA36A5;">err</span>, <span style="color: #BA36A5;">debug</span> = message.parse_error()
            <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Error from '{}':"</span>.<span style="color: #006FE0;">format</span>(error_source), err.message)
            <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Debug info:"</span>, debug)
        <span style="color: #0000FF;">elif</span> t != Gst.MessageType.EOS:
            <span style="color: #0000FF;">return</span>
        <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.NULL)
        <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Start"</span>)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">on_sync_message</span>(<span style="color: #0000FF;">self</span>, bus, message):
        <span style="color: #BA36A5;">message_name</span> = message.get_structure().get_name()
        <span style="color: #0000FF;">if</span> message_name != <span style="color: #008000;">"prepare-window-handle"</span>:
            <span style="color: #0000FF;">return</span>
        <span style="color: #BA36A5;">imagesink</span> = message.src
        imagesink.set_property(<span style="color: #008000;">"force-aspect-ratio"</span>, <span style="color: #D0372D;">True</span>)
        <span style="color: #BA36A5;">window_id</span> = <span style="color: #0000FF;">self</span>.movie_window.get_property(<span style="color: #008000;">"window"</span>).get_xid()
        imagesink.set_window_handle(window_id)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">demuxer_callback</span>(<span style="color: #0000FF;">self</span>, demuxer, pad):
        <span style="color: #BA36A5;">name_template</span> = pad.get_property(<span style="color: #008000;">"template"</span>).name_template
        <span style="color: #0000FF;">if</span> name_template == <span style="color: #008000;">"video_%02x"</span>:
            pad.link(<span style="color: #0000FF;">self</span>.queuev.get_static_pad(<span style="color: #008000;">"sink"</span>))
        <span style="color: #0000FF;">elif</span> name_template == <span style="color: #008000;">"audio_%02x"</span>:
            pad.link(<span style="color: #0000FF;">self</span>.queuea.get_static_pad(<span style="color: #008000;">"sink"</span>))


<span style="color: #0000FF;">if</span> <span style="color: #006FE0;">__name__</span> == <span style="color: #008000;">"__main__"</span>:
    Gst.init(sys.argv)
    Gtk.init(sys.argv)
    GTK_Main()
    Gtk.main()
</pre>
</div>

<p>
The elements in a pipeline connects to each other with pads and that's what the next chapter will tell you more about.
</p>
</div>
</div>
</div>

<div id="outline-container-org3c23bb9" class="outline-2">
<h2 id="org3c23bb9"><span class="section-number-2">5</span> Src, sink, pad &#x2026; oh my!</h2>
<div class="outline-text-2" id="text-5">
<p>
<a id="orgfc7a802"></a>
</p>

<p>
As their names imply, a <i>src</i> is an object that is "sending" data and a <i>sink</i> is an object that is "receiving" data. These objects connect to each other with <i>pads</i>. Pads could be either <i>src</i> or <i>sink</i>. Most elements have both <i>src</i> and <i>sink</i> pads. For example, the <code>mpg123audiodec</code> MP3 decoder element looks something like the figure below:
</p>



<figure id="orgb72bd86">
<object type="image/svg+xml" data="sink-src-block.svg" class="org-svg">
Sorry, your browser does not support SVG.</object>

</figure>


<p>
And as always if you want to know more about highlevel elements gst-inspect is your friend:
</p>

<div class="org-src-container">
<pre class="src src-sh">gst-inspect-1.0 mpg123audiodec
</pre>
</div>

<p>
In particular, the inheritance diagram shows that <code>mpg123audiodec</code> is an element:
</p>

<pre class="example" id="org6594f8f">
GObject
 +----GInitiallyUnowned
       +----GstObject
             +----GstElement
                   +----GstAudioDecoder
                         +----GstMpg123AudioDec
</pre>

<p>
There are many different ways to link elements together. In <code>pipeline-example.py</code> we used the <code>Gst.Pipeline.add()</code> and the <code>.link()</code> method of the produced elements. You can also make a completely ready-to-go pipeline with the <code>parse_launch()</code> function. The many <code>.add()</code> calls in that example can be rewritten as:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #BA36A5;">mp3_pipeline</span> = Gst.parse_launch(
    <span style="color: #008000;">"filesrc name=file-source ! mpegaudioparse name=mp3-parse"</span>
    <span style="color: #008000;">" ! mpg123audiodec name=mp3-decoder ! audioconvert name=converter"</span>
    <span style="color: #008000;">" ! autoaudiosink name=audio-out"</span>
)
</pre>
</div>

<p>
The micro-language used in this function call is that of the <code>gst-launch</code> command line program.
</p>

<p>
<a id="orga60ce66"></a>
When you do manually link pads with the <code>.link()</code> method make sure that you link a <i>src</i>-pad to a <i>sink</i>-pad. No rule though without exceptions. A <a href="https://lazka.github.io/pgi-docs/Gst-1.0/classes/GhostPad.html"><code>Gst.GhostPad</code></a> should be linked to a pad of the same kind as itself. We have already showed how a ghost pad works in the addition to example <a href="#org4ec0403">3.2</a>. A <a href="https://lazka.github.io/pgi-docs/Gst-1.0/classes/Bin.html"><code>Gst.Bin</code></a> can't link to other objects if you don't link a <a href="https://lazka.github.io/pgi-docs/Gst-1.0/classes/GhostPad.html"><code>Gst.GhostPad</code></a> to an element inside the bin. The <code>playbin-example-video.py</code> example in section <a href="#org4ec0403">3.2</a> should look something like this:
</p>


<figure id="orgd17e594">
<object type="image/svg+xml" data="playbin-pads-block.svg" class="org-svg">
Sorry, your browser does not support SVG.</object>

</figure>


<p>
And the ghostpad above should be created as type <b>"sink"</b>!
</p>

<p>
Some pads are not always available and are only created when they are in use. Such pads are called <a href="https://gstreamer.freedesktop.org/documentation/application-development/basics/pads.html#dynamic-or-sometimes-pads">"dynamic pads"</a>. The next example will show how to use dynamically created pads with an <a href="https://gstreamer.freedesktop.org/documentation/ogg/oggdemux.html"><code>oggdemux</code></a>. The link between the demuxer and the decoder is created with the <code>demuxer_callback()</code> method, which is called whenever a pad is created in the demuxer using the "<code>pad-added</code>" signal.
</p>

<a href="dynamic-ghostpad-example.py">dynamic-ghostpad-example.py</a>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">!/usr/bin/env python</span>

<span style="color: #0000FF;">import</span> os
<span style="color: #0000FF;">import</span> sys
<span style="color: #0000FF;">import</span> gi

gi.require_version(<span style="color: #008000;">"Gst"</span>, <span style="color: #008000;">"1.0"</span>)
gi.require_version(<span style="color: #008000;">"Gtk"</span>, <span style="color: #008000;">"3.0"</span>)

<span style="color: #0000FF;">from</span> gi.repository <span style="color: #0000FF;">import</span> Gst, Gtk  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">noqa: E402</span>


<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">GTK_Main</span>(<span style="color: #006FE0;">object</span>):
    <span style="color: #0000FF;">def</span> <span style="color: #006699;">__init__</span>(<span style="color: #0000FF;">self</span>):
        <span style="color: #BA36A5;">window</span> = Gtk.Window(<span style="color: #006FE0;">type</span>=Gtk.WindowType.TOPLEVEL)
        window.set_title(<span style="color: #008000;">"Vorbis-Player"</span>)
        window.set_default_size(500, -1)
        window.connect(<span style="color: #008000;">"destroy"</span>, Gtk.main_quit, <span style="color: #008000;">"WM destroy"</span>)

        <span style="color: #BA36A5;">vbox</span> = Gtk.VBox()
        window.add(vbox)
        <span style="color: #0000FF;">self</span>.entry = Gtk.Entry()
        vbox.pack_start(<span style="color: #0000FF;">self</span>.entry, <span style="color: #D0372D;">False</span>, <span style="color: #D0372D;">False</span>, 0)
        <span style="color: #0000FF;">self</span>.button = Gtk.Button(label=<span style="color: #008000;">"Start"</span>)
        vbox.add(<span style="color: #0000FF;">self</span>.button)
        <span style="color: #0000FF;">self</span>.button.connect(<span style="color: #008000;">"clicked"</span>, <span style="color: #0000FF;">self</span>.start_stop)
        window.show_all()

        <span style="color: #0000FF;">self</span>.player = Gst.Pipeline.new(<span style="color: #008000;">"player"</span>)
        <span style="color: #BA36A5;">make_element</span> = Gst.ElementFactory.make
        <span style="color: #BA36A5;">source</span> = make_element(<span style="color: #008000;">"filesrc"</span>, <span style="color: #008000;">"file-source"</span>)
        <span style="color: #BA36A5;">demuxer</span> = make_element(<span style="color: #008000;">"oggdemux"</span>, <span style="color: #008000;">"demuxer"</span>)
        demuxer.connect(<span style="color: #008000;">"pad-added"</span>, <span style="color: #0000FF;">self</span>.demuxer_callback)
        <span style="color: #0000FF;">self</span>.audio_decoder = make_element(<span style="color: #008000;">"vorbisdec"</span>, <span style="color: #008000;">"vorbis-decoder"</span>)
        <span style="color: #BA36A5;">audioconv</span> = make_element(<span style="color: #008000;">"audioconvert"</span>, <span style="color: #008000;">"converter"</span>)
        <span style="color: #BA36A5;">audiosink</span> = make_element(<span style="color: #008000;">"autoaudiosink"</span>, <span style="color: #008000;">"audio-output"</span>)

        <span style="color: #0000FF;">for</span> e <span style="color: #0000FF;">in</span> (source, demuxer, <span style="color: #0000FF;">self</span>.audio_decoder, audioconv, audiosink):
            <span style="color: #0000FF;">self</span>.player.add(e)

        source.link(demuxer)
        <span style="color: #0000FF;">self</span>.audio_decoder.link(audioconv)
        audioconv.link(audiosink)

        <span style="color: #BA36A5;">bus</span> = <span style="color: #0000FF;">self</span>.player.get_bus()
        bus.add_signal_watch()
        bus.connect(<span style="color: #008000;">"message"</span>, <span style="color: #0000FF;">self</span>.on_message)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">start_stop</span>(<span style="color: #0000FF;">self</span>, w):
        <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">self</span>.button.get_label() == <span style="color: #008000;">"Start"</span>:
            <span style="color: #BA36A5;">filepath</span> = <span style="color: #0000FF;">self</span>.entry.get_text().strip()
            <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">not</span> os.path.isfile(filepath):
                <span style="color: #0000FF;">return</span>
            <span style="color: #BA36A5;">filepath</span> = os.path.realpath(filepath)
            <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Stop"</span>)
            <span style="color: #BA36A5;">src</span> = <span style="color: #0000FF;">self</span>.player.get_by_name(<span style="color: #008000;">"file-source"</span>)
            src.set_property(<span style="color: #008000;">"location"</span>, filepath)
            <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.PLAYING)
        <span style="color: #0000FF;">else</span>:
            <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.NULL)
            <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Start"</span>)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">on_message</span>(<span style="color: #0000FF;">self</span>, bus, message):
        <span style="color: #BA36A5;">t</span> = message.<span style="color: #006FE0;">type</span>
        <span style="color: #0000FF;">if</span> t == Gst.MessageType.ERROR:
            <span style="color: #BA36A5;">error_source</span> = message.src.name
            <span style="color: #BA36A5;">err</span>, <span style="color: #BA36A5;">debug</span> = message.parse_error()
            <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Error from '{}':"</span>.<span style="color: #006FE0;">format</span>(error_source), err.message)
            <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Debug info:"</span>, debug)
        <span style="color: #0000FF;">elif</span> t != Gst.MessageType.EOS:
            <span style="color: #0000FF;">return</span>
        <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.NULL)
        <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Start"</span>)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">demuxer_callback</span>(<span style="color: #0000FF;">self</span>, demuxer, pad):
        <span style="color: #BA36A5;">adec_pad</span> = <span style="color: #0000FF;">self</span>.audio_decoder.get_static_pad(<span style="color: #008000;">"sink"</span>)
        pad.link(adec_pad)


<span style="color: #0000FF;">if</span> <span style="color: #006FE0;">__name__</span> == <span style="color: #008000;">"__main__"</span>:
    Gst.init(sys.argv)
    Gtk.init(sys.argv)
    GTK_Main()
    Gtk.main()
</pre>
</div>

<p>
Now after reading through these four chapters you could need a break. Happy hacking and stay tuned for more interesting chapters to come.
</p>
</div>
</div>

<div id="outline-container-orge6a9d43" class="outline-2">
<h2 id="orge6a9d43"><span class="section-number-2">6</span> Seeking</h2>
<div class="outline-text-2" id="text-6">
<p>
<a id="org03ab206"></a>
</p>

<p>
Seeking in GStreamer is done with the <a href="https://lazka.github.io/pgi-docs/Gst-1.0/classes/Element.html#Gst.Element.seek"><code>seek()</code></a> and <a href="https://lazka.github.io/pgi-docs/Gst-1.0/classes/Element.html#Gst.Element.seek_simple"><code>seek_simple()</code></a> methods of <a href="https://lazka.github.io/pgi-docs/Gst-1.0/classes/Element.html"><code>Gst.Element</code></a>.
To be able to seek you will also need to tell GStreamer what kind of seek it should do. In the following example we will use a <a href="https://lazka.github.io/pgi-docs/Gst-1.0/enums.html#Gst.Format.TIME"><code>TIME</code></a> constant from <a href="https://lazka.github.io/pgi-docs/Gst-1.0/enums.html#Gst.Format"><code>Gst.Format</code></a> enum which will, as you may guess, request a time seek. We will also use the <a href="https://lazka.github.io/pgi-docs/Gst-1.0/classes/Element.html#Gst.Element.query_duration"><code>query_duration()</code></a> and <a href="https://lazka.github.io/pgi-docs/Gst-1.0/classes/Element.html#Gst.Element.query_position"><code>query_position()</code></a> methods to get the file length and how long the file has currently played. GStreamer uses nanoseconds by default so you have to adjust to that. Note that we cannot request duration or current position until our pipeline reaches <code>PAUSED</code> or <code>PLAYING</code> state.
</p>

<p>
In this next example we take the Vorbis-Player from example <a href="#orgfc7a802">5</a> and update it with some more stuff so it's able to seek and show duration and position.
</p>

<a href="seeking-example.py">seeking-example.py</a>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">!/usr/bin/env python</span>

<span style="color: #0000FF;">import</span> os
<span style="color: #0000FF;">import</span> sys
<span style="color: #0000FF;">import</span> gi

gi.require_version(<span style="color: #008000;">"Gst"</span>, <span style="color: #008000;">"1.0"</span>)
gi.require_version(<span style="color: #008000;">"GstVideo"</span>, <span style="color: #008000;">"1.0"</span>)
gi.require_version(<span style="color: #008000;">"Gtk"</span>, <span style="color: #008000;">"3.0"</span>)

<span style="color: #0000FF;">from</span> gi.repository <span style="color: #0000FF;">import</span> Gst, GLib, Gtk  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">noqa: E402</span>


<span style="color: #BA36A5;">NS_IN_SECOND</span> = 1_000_000_000
<span style="color: #BA36A5;">PREROLL_FINISHED</span> = (Gst.State.READY, Gst.State.PAUSED, Gst.State.PLAYING)


<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">GTK_Main</span>:
    <span style="color: #0000FF;">def</span> <span style="color: #006699;">__init__</span>(<span style="color: #0000FF;">self</span>):
        <span style="color: #0000FF;">self</span>.position_refresh_id = <span style="color: #D0372D;">None</span>
        <span style="color: #0000FF;">self</span>._duration_str = <span style="color: #008000;">""</span>

        <span style="color: #BA36A5;">window</span> = Gtk.Window(<span style="color: #006FE0;">type</span>=Gtk.WindowType.TOPLEVEL)
        window.set_title(<span style="color: #008000;">"Vorbis-Player"</span>)
        window.set_default_size(500, -1)
        window.connect(<span style="color: #008000;">"destroy"</span>, Gtk.main_quit, <span style="color: #008000;">"WM destroy"</span>)
        <span style="color: #BA36A5;">vbox</span> = Gtk.VBox()
        window.add(vbox)
        <span style="color: #0000FF;">self</span>.entry = Gtk.Entry()
        vbox.pack_start(<span style="color: #0000FF;">self</span>.entry, <span style="color: #D0372D;">False</span>, <span style="color: #D0372D;">False</span>, 0)
        <span style="color: #BA36A5;">hbox</span> = Gtk.HBox()
        vbox.add(hbox)
        <span style="color: #BA36A5;">buttonbox</span> = Gtk.HButtonBox()
        hbox.pack_start(buttonbox, <span style="color: #D0372D;">False</span>, <span style="color: #D0372D;">False</span>, 0)
        <span style="color: #BA36A5;">rewind_button</span> = Gtk.Button(label=<span style="color: #008000;">"Rewind"</span>)
        rewind_button.connect(<span style="color: #008000;">"clicked"</span>, <span style="color: #0000FF;">self</span>.rewind_callback)
        buttonbox.add(rewind_button)
        <span style="color: #0000FF;">self</span>.button = Gtk.Button(label=<span style="color: #008000;">"Start"</span>)
        <span style="color: #0000FF;">self</span>.button.connect(<span style="color: #008000;">"clicked"</span>, <span style="color: #0000FF;">self</span>.start_stop)
        buttonbox.add(<span style="color: #0000FF;">self</span>.button)
        <span style="color: #BA36A5;">forward_button</span> = Gtk.Button(label=<span style="color: #008000;">"Forward"</span>)
        forward_button.connect(<span style="color: #008000;">"clicked"</span>, <span style="color: #0000FF;">self</span>.forward_callback)
        buttonbox.add(forward_button)
        <span style="color: #0000FF;">self</span>.time_label = Gtk.Label()
        <span style="color: #0000FF;">self</span>.time_label.set_text(<span style="color: #008000;">"00:00 / 00:00"</span>)
        hbox.add(<span style="color: #0000FF;">self</span>.time_label)
        window.show_all()

        <span style="color: #0000FF;">self</span>.player = Gst.Pipeline.new(<span style="color: #008000;">"player"</span>)
        <span style="color: #BA36A5;">make_element</span> = Gst.ElementFactory.make
        <span style="color: #BA36A5;">source</span> = make_element(<span style="color: #008000;">"filesrc"</span>, <span style="color: #008000;">"file-source"</span>)
        <span style="color: #BA36A5;">demuxer</span> = make_element(<span style="color: #008000;">"oggdemux"</span>, <span style="color: #008000;">"demuxer"</span>)
        demuxer.connect(<span style="color: #008000;">"pad-added"</span>, <span style="color: #0000FF;">self</span>.demuxer_callback)
        <span style="color: #0000FF;">self</span>.audio_decoder = make_element(<span style="color: #008000;">"vorbisdec"</span>, <span style="color: #008000;">"vorbis-decoder"</span>)
        <span style="color: #BA36A5;">audioconv</span> = make_element(<span style="color: #008000;">"audioconvert"</span>, <span style="color: #008000;">"converter"</span>)
        <span style="color: #BA36A5;">audiosink</span> = make_element(<span style="color: #008000;">"autoaudiosink"</span>, <span style="color: #008000;">"audio-output"</span>)

        <span style="color: #0000FF;">for</span> e <span style="color: #0000FF;">in</span> (source, demuxer, <span style="color: #0000FF;">self</span>.audio_decoder, audioconv, audiosink):
            <span style="color: #0000FF;">self</span>.player.add(e)
        source.link(demuxer)
        <span style="color: #0000FF;">self</span>.audio_decoder.link(audioconv)
        audioconv.link(audiosink)

        <span style="color: #BA36A5;">bus</span> = <span style="color: #0000FF;">self</span>.player.get_bus()
        bus.add_signal_watch()
        bus.connect(<span style="color: #008000;">"message"</span>, <span style="color: #0000FF;">self</span>.on_message)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">start_stop</span>(<span style="color: #0000FF;">self</span>, w):
        <span style="color: #0000FF;">self</span>.time_label.set_text(<span style="color: #008000;">"00:00 / 00:00"</span>)
        <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">self</span>.button.get_label() == <span style="color: #008000;">"Start"</span>:
            <span style="color: #BA36A5;">filepath</span> = <span style="color: #0000FF;">self</span>.entry.get_text().strip()
            <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">not</span> os.path.isfile(filepath):
                <span style="color: #0000FF;">return</span>
            <span style="color: #BA36A5;">filepath</span> = os.path.realpath(filepath)
            <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Stop"</span>)
            <span style="color: #BA36A5;">filesrc</span> = <span style="color: #0000FF;">self</span>.player.get_by_name(<span style="color: #008000;">"file-source"</span>)
            filesrc.set_property(<span style="color: #008000;">"location"</span>, filepath)
            <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.PLAYING)
        <span style="color: #0000FF;">else</span>:
            GLib.source_remove(<span style="color: #0000FF;">self</span>.position_refresh_id)
            <span style="color: #0000FF;">self</span>.position_refresh_id = <span style="color: #D0372D;">None</span>
            <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.NULL)
            <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Start"</span>)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">position_refresh</span>(<span style="color: #0000FF;">self</span>):
        <span style="color: #BA36A5;">_</span>, <span style="color: #BA36A5;">current_pos</span> = <span style="color: #0000FF;">self</span>.player.query_position(Gst.Format.TIME)
        <span style="color: #BA36A5;">pos_str</span> = <span style="color: #0000FF;">self</span>.format_ns(current_pos)
        <span style="color: #0000FF;">self</span>.time_label.set_text(pos_str + <span style="color: #008000;">" / "</span> + <span style="color: #0000FF;">self</span>._duration_str)
        <span style="color: #0000FF;">return</span> GLib.SOURCE_CONTINUE

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">on_message</span>(<span style="color: #0000FF;">self</span>, bus, message):
        <span style="color: #BA36A5;">t</span> = message.<span style="color: #006FE0;">type</span>
        <span style="color: #0000FF;">if</span> t == Gst.MessageType.STATE_CHANGED:
            <span style="color: #BA36A5;">state_transition</span> = message.parse_state_changed()
            <span style="color: #0000FF;">if</span> state_transition != PREROLL_FINISHED:
                <span style="color: #0000FF;">return</span>
            <span style="color: #BA36A5;">_</span>, <span style="color: #BA36A5;">duration</span> = <span style="color: #0000FF;">self</span>.player.query_duration(Gst.Format.TIME)
            <span style="color: #0000FF;">self</span>._duration_str = <span style="color: #0000FF;">self</span>.format_ns(duration)
            <span style="color: #0000FF;">self</span>.time_label.set_text(<span style="color: #008000;">"00:00 / "</span> + <span style="color: #0000FF;">self</span>._duration_str)
            <span style="color: #BA36A5;">position_refresh_id</span> = GLib.timeout_add(500, <span style="color: #0000FF;">self</span>.position_refresh)
            <span style="color: #0000FF;">self</span>.position_refresh_id = position_refresh_id
            <span style="color: #0000FF;">return</span>
        <span style="color: #0000FF;">elif</span> t == Gst.MessageType.ERROR:
            <span style="color: #BA36A5;">error_source</span> = message.src.name
            <span style="color: #BA36A5;">err</span>, <span style="color: #BA36A5;">debug</span> = message.parse_error()
            <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Error from '{}':"</span>.<span style="color: #006FE0;">format</span>(error_source), err.message)
            <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Debug info:"</span>, debug)
        <span style="color: #0000FF;">elif</span> t != Gst.MessageType.EOS:
            <span style="color: #0000FF;">return</span>
        GLib.source_remove(<span style="color: #0000FF;">self</span>.position_refresh_id)
        <span style="color: #0000FF;">self</span>.position_refresh_id = <span style="color: #D0372D;">None</span>
        <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.NULL)
        <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Start"</span>)
        <span style="color: #0000FF;">self</span>.time_label.set_text(<span style="color: #008000;">"00:00 / 00:00"</span>)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">demuxer_callback</span>(<span style="color: #0000FF;">self</span>, demuxer, pad):
        <span style="color: #BA36A5;">dec_pad</span> = <span style="color: #0000FF;">self</span>.audio_decoder.get_static_pad(<span style="color: #008000;">"sink"</span>)
        pad.link(dec_pad)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">rewind_callback</span>(<span style="color: #0000FF;">self</span>, w):
        <span style="color: #BA36A5;">_</span>, <span style="color: #BA36A5;">current_pos</span> = <span style="color: #0000FF;">self</span>.player.query_position(Gst.Format.TIME)
        <span style="color: #BA36A5;">new_pos</span> = <span style="color: #006FE0;">max</span>(0, current_pos - 10 * NS_IN_SECOND)
        <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Backward:"</span>, current_pos, <span style="color: #008000;">"ns -&gt; "</span>, new_pos, <span style="color: #008000;">" ns"</span>)
        <span style="color: #0000FF;">self</span>.player.seek_simple(Gst.Format.TIME, Gst.SeekFlags.FLUSH, new_pos)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">forward_callback</span>(<span style="color: #0000FF;">self</span>, w):
        <span style="color: #BA36A5;">_</span>, <span style="color: #BA36A5;">current_pos</span> = <span style="color: #0000FF;">self</span>.player.query_position(Gst.Format.TIME)
        <span style="color: #BA36A5;">new_pos</span> = current_pos + 10 * NS_IN_SECOND
        <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Forward:"</span>, current_pos, <span style="color: #008000;">"ns -&gt; "</span>, new_pos, <span style="color: #008000;">" ns"</span>)
        <span style="color: #0000FF;">self</span>.player.seek_simple(Gst.Format.TIME, Gst.SeekFlags.FLUSH, new_pos)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">format_ns</span>(<span style="color: #0000FF;">self</span>, t):
        <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">This method was submitted by Sam Mason.</span>
        <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">It's much shorter than the original one.</span>
        <span style="color: #BA36A5;">s</span>, <span style="color: #BA36A5;">ns</span> = <span style="color: #006FE0;">divmod</span>(t, NS_IN_SECOND)
        <span style="color: #BA36A5;">m</span>, <span style="color: #BA36A5;">s</span> = <span style="color: #006FE0;">divmod</span>(s, 60)

        <span style="color: #0000FF;">if</span> m &lt; 60:
            <span style="color: #0000FF;">return</span> <span style="color: #008000;">"%02i:%02i"</span> % (m, s)
        <span style="color: #0000FF;">else</span>:
            <span style="color: #BA36A5;">h</span>, <span style="color: #BA36A5;">m</span> = <span style="color: #006FE0;">divmod</span>(m, 60)
            <span style="color: #0000FF;">return</span> <span style="color: #008000;">"%i:%02i:%02i"</span> % (h, m, s)


<span style="color: #0000FF;">if</span> <span style="color: #006FE0;">__name__</span> == <span style="color: #008000;">"__main__"</span>:
    Gst.init(sys.argv)
    Gtk.init(sys.argv)
    GTK_Main()
    Gtk.main()
</pre>
</div>

<p>
Methods <a href="https://lazka.github.io/pgi-docs/Gst-1.0/classes/Element.html#Gst.Element.query_duration"><code>query_duration()</code></a> and <a href="https://lazka.github.io/pgi-docs/Gst-1.0/classes/Element.html#Gst.Element.query_position"><code>query_position()</code></a> are a convenience wrappers that will create corresponding <a href="https://lazka.github.io/pgi-docs/Gst-1.0/classes/Query.html"><code>Gst.Query</code></a> object and send it to <a href="https://lazka.github.io/pgi-docs/Gst-1.0/classes/Element.html#Gst.Element.query"><code>query()</code></a> method. Since we repeatedly call <a href="https://lazka.github.io/pgi-docs/Gst-1.0/classes/Element.html#Gst.Element.query_position"><code>query_position()</code></a> we can reuse query object by adding a couple of declarations to our <code>GTK_Main</code> class:
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #0000FF;">def</span> <span style="color: #006699;">__init__</span>(<span style="color: #0000FF;">self</span>):
    <span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">...</span>
    <span style="color: #0000FF;">self</span>._position_query = Gst.Query.new_position(Gst.Format.TIME)
    <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">...</span>

<span style="color: #0000FF;">def</span> <span style="color: #006699;">_query_position</span>(<span style="color: #0000FF;">self</span>):
    <span style="color: #0000FF;">self</span>.player.query(<span style="color: #0000FF;">self</span>._position_query)
    <span style="color: #0000FF;">return</span> <span style="color: #0000FF;">self</span>._position_query.parse_position()
</pre>
</div>

<p>
After that we can replace
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #0000FF;">self</span>.player.query_position(Gst.Format.TIME)
</pre>
</div>

<p>
with
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #0000FF;">self</span>._query_position()
</pre>
</div>
</div>
</div>


<div id="outline-container-org922ed9a" class="outline-2">
<h2 id="org922ed9a"><span class="section-number-2">7</span> Capabilities</h2>
<div class="outline-text-2" id="text-7">
<p>
<a id="org281f495"></a>
</p>

<p>
Capabilities, <a href="https://lazka.github.io/pgi-docs/Gst-1.0/structs/Caps.html"><code>Gst.Caps</code></a>, is a container where you may store information that you may pass on to a <a href="https://lazka.github.io/pgi-docs/Gst-1.0/classes/PadTemplate.html"><code>Gst.PadTemplate</code></a>. When you set the pipeline state to either playing or paused the elements pads negotiates what caps to use for the stream. Now the following pipeline works perfectly:
</p>

<div class="org-src-container">
<pre class="src src-sh">gst-launch-1.0  videotestsrc ! video/x-raw, <span style="color: #BA36A5;">width</span>=320, <span style="color: #BA36A5;">height</span>=240 <span style="color: #008000;">\</span>
                ! xvimagesink
</pre>
</div>

<p>
But if you try to switch out the <a href="https://gstreamer.freedesktop.org/documentation/xvimagesink/index.html"><code>xvimagesink</code></a> for an <a href="https://gstreamer.freedesktop.org/documentation/ximagesink/index.html"><code>ximagesink</code></a> you will notice that it wouldn't work. That's because <code>ximagesink</code> can't handle <code>video/x-raw</code> so you must put in an element BEFORE in the pipeline that does.
</p>

<div class="org-src-container">
<pre class="src src-sh">gst-launch-1.0  videotestsrc ! video/x-raw, <span style="color: #BA36A5;">width</span>=320, <span style="color: #BA36A5;">height</span>=240 <span style="color: #008000;">\</span>
                ! videoconvert ! ximagesink
</pre>
</div>

<p>
And as <code>ximagesink</code> does not support hardware scaling you have to throw in a <a href="https://gstreamer.freedesktop.org/documentation/videoscale/index.html"><code>videoscale</code></a> element too if you want software scaling.
</p>

<div class="org-src-container">
<pre class="src src-sh">gst-launch-1.0  videotestsrc ! video/x-raw, <span style="color: #BA36A5;">width</span>=320, <span style="color: #BA36A5;">height</span>=240 <span style="color: #008000;">\</span>
                ! videoscale ! videoconvert ! ximagesink
</pre>
</div>

<p>
To put the above examples in code you have to put the caps in a capsfilter element.
</p>

<a href="capabilities-example.py">capabilities-example.py</a>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">!/usr/bin/env python</span>

<span style="color: #0000FF;">import</span> sys
<span style="color: #0000FF;">import</span> gi

gi.require_version(<span style="color: #008000;">"Gst"</span>, <span style="color: #008000;">"1.0"</span>)
gi.require_version(<span style="color: #008000;">"Gtk"</span>, <span style="color: #008000;">"3.0"</span>)

<span style="color: #0000FF;">from</span> gi.repository <span style="color: #0000FF;">import</span> Gst, Gtk  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">noqa: E402</span>


<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">GTK_Main</span>:
    <span style="color: #0000FF;">def</span> <span style="color: #006699;">__init__</span>(<span style="color: #0000FF;">self</span>):
        <span style="color: #BA36A5;">window</span> = Gtk.Window(<span style="color: #006FE0;">type</span>=Gtk.WindowType.TOPLEVEL)
        window.set_title(<span style="color: #008000;">"Videotestsrc-Player"</span>)
        window.set_default_size(300, -1)
        window.connect(<span style="color: #008000;">"destroy"</span>, Gtk.main_quit, <span style="color: #008000;">"WM destroy"</span>)
        <span style="color: #BA36A5;">vbox</span> = Gtk.VBox()
        window.add(vbox)
        <span style="color: #0000FF;">self</span>.button = Gtk.Button(label=<span style="color: #008000;">"Start"</span>)
        <span style="color: #0000FF;">self</span>.button.connect(<span style="color: #008000;">"clicked"</span>, <span style="color: #0000FF;">self</span>.start_stop)
        vbox.add(<span style="color: #0000FF;">self</span>.button)
        window.show_all()

        <span style="color: #0000FF;">self</span>.player = Gst.Pipeline.new(<span style="color: #008000;">"player"</span>)

        <span style="color: #BA36A5;">source</span> = Gst.ElementFactory.make(<span style="color: #008000;">"videotestsrc"</span>, <span style="color: #008000;">"video-source"</span>)
        <span style="color: #0000FF;">self</span>.player.add(source)

        <span style="color: #006FE0;">filter</span> = Gst.ElementFactory.make(<span style="color: #008000;">"capsfilter"</span>, <span style="color: #008000;">"filter"</span>)
        <span style="color: #0000FF;">self</span>.player.add(<span style="color: #006FE0;">filter</span>)
        <span style="color: #BA36A5;">caps</span> = Gst.Caps.from_string(<span style="color: #008000;">"video/x-raw, width=320, height=230"</span>)
        <span style="color: #006FE0;">filter</span>.set_property(<span style="color: #008000;">"caps"</span>, caps)
        source.link(<span style="color: #006FE0;">filter</span>)

        <span style="color: #BA36A5;">sink</span> = Gst.ElementFactory.make(<span style="color: #008000;">"xvimagesink"</span>, <span style="color: #008000;">"video-output"</span>)
        <span style="color: #0000FF;">self</span>.player.add(sink)
        <span style="color: #006FE0;">filter</span>.link(sink)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">start_stop</span>(<span style="color: #0000FF;">self</span>, w):
        <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">self</span>.button.get_label() == <span style="color: #008000;">"Start"</span>:
            <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Stop"</span>)
            <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.PLAYING)
        <span style="color: #0000FF;">else</span>:
            <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.NULL)
            <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Start"</span>)


<span style="color: #0000FF;">if</span> <span style="color: #006FE0;">__name__</span> == <span style="color: #008000;">"__main__"</span>:
    Gst.init(sys.argv)
    Gtk.init(sys.argv)
    GTK_Main()
    Gtk.main()
</pre>
</div>

<p>
A frequently asked question is how to find out what resolution a file has and one way to do it is to check the caps on a decodebin element in paused state.
</p>

<a href="capabilities-resolution-example.py">capabilities-resolution-example.py</a>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">!/usr/bin/env python</span>

<span style="color: #0000FF;">import</span> os
<span style="color: #0000FF;">import</span> sys
<span style="color: #0000FF;">import</span> gi

gi.require_version(<span style="color: #008000;">"Gst"</span>, <span style="color: #008000;">"1.0"</span>)
gi.require_version(<span style="color: #008000;">"Gtk"</span>, <span style="color: #008000;">"3.0"</span>)

<span style="color: #0000FF;">from</span> gi.repository <span style="color: #0000FF;">import</span> Gst, Gtk  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">noqa: E402</span>


<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">GTK_Main</span>:
    <span style="color: #0000FF;">def</span> <span style="color: #006699;">__init__</span>(<span style="color: #0000FF;">self</span>):
        <span style="color: #BA36A5;">window</span> = Gtk.Window(<span style="color: #006FE0;">type</span>=Gtk.WindowType.TOPLEVEL)
        window.set_title(<span style="color: #008000;">"Resolutionchecker"</span>)
        window.set_default_size(300, -1)
        window.connect(<span style="color: #008000;">"destroy"</span>, Gtk.main_quit, <span style="color: #008000;">"WM destroy"</span>)

        <span style="color: #BA36A5;">vbox</span> = Gtk.VBox()
        window.add(vbox)
        <span style="color: #0000FF;">self</span>.entry = Gtk.Entry()
        vbox.pack_start(<span style="color: #0000FF;">self</span>.entry, <span style="color: #D0372D;">False</span>, <span style="color: #D0372D;">True</span>, 0)
        <span style="color: #0000FF;">self</span>.button = Gtk.Button(label=<span style="color: #008000;">"Check"</span>)
        <span style="color: #0000FF;">self</span>.button.connect(<span style="color: #008000;">"clicked"</span>, <span style="color: #0000FF;">self</span>.start_stop)
        vbox.add(<span style="color: #0000FF;">self</span>.button)
        <span style="color: #0000FF;">self</span>.resolution_label = Gtk.Label()
        vbox.add(<span style="color: #0000FF;">self</span>.resolution_label)
        window.show_all()

        <span style="color: #0000FF;">self</span>.player = Gst.Pipeline.new(<span style="color: #008000;">"player"</span>)
        <span style="color: #BA36A5;">make_element</span> = Gst.ElementFactory.make
        <span style="color: #BA36A5;">source</span> = make_element(<span style="color: #008000;">"filesrc"</span>, <span style="color: #008000;">"file-source"</span>)
        <span style="color: #BA36A5;">decoder</span> = make_element(<span style="color: #008000;">"decodebin"</span>, <span style="color: #008000;">"decoder"</span>)
        decoder.connect(<span style="color: #008000;">"pad-added"</span>, <span style="color: #0000FF;">self</span>.decoder_callback)
        <span style="color: #0000FF;">self</span>.fakea = make_element(<span style="color: #008000;">"fakesink"</span>, <span style="color: #008000;">"fakea"</span>)
        <span style="color: #0000FF;">self</span>.fakev = make_element(<span style="color: #008000;">"fakesink"</span>, <span style="color: #008000;">"fakev"</span>)
        <span style="color: #0000FF;">self</span>.player.add(source)
        <span style="color: #0000FF;">self</span>.player.add(decoder)
        <span style="color: #0000FF;">self</span>.player.add(<span style="color: #0000FF;">self</span>.fakea)
        <span style="color: #0000FF;">self</span>.player.add(<span style="color: #0000FF;">self</span>.fakev)
        source.link(decoder)

        <span style="color: #BA36A5;">bus</span> = <span style="color: #0000FF;">self</span>.player.get_bus()
        bus.add_signal_watch()
        bus.connect(<span style="color: #008000;">"message"</span>, <span style="color: #0000FF;">self</span>.on_message)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">start_stop</span>(<span style="color: #0000FF;">self</span>, w):
        <span style="color: #BA36A5;">filepath</span> = <span style="color: #0000FF;">self</span>.entry.get_text().strip()
        <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">not</span> os.path.isfile(filepath):
            <span style="color: #0000FF;">return</span>
        <span style="color: #BA36A5;">filepath</span> = os.path.realpath(filepath)
        <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.NULL)
        <span style="color: #BA36A5;">src</span> = <span style="color: #0000FF;">self</span>.player.get_by_name(<span style="color: #008000;">"file-source"</span>)
        src.set_property(<span style="color: #008000;">"location"</span>, filepath)
        <span style="color: #0000FF;">self</span>.resolution_label.set_text(<span style="color: #008000;">""</span>)
        <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.PAUSED)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">on_message</span>(<span style="color: #0000FF;">self</span>, bus, message):
        <span style="color: #BA36A5;">t</span> = message.<span style="color: #006FE0;">type</span>
        <span style="color: #0000FF;">if</span> t == Gst.MessageType.ERROR:
            <span style="color: #BA36A5;">error_source</span> = message.src.name
            <span style="color: #BA36A5;">err</span>, <span style="color: #BA36A5;">debug</span> = message.parse_error()
            <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Error from '{}':"</span>.<span style="color: #006FE0;">format</span>(error_source), err.message)
            <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Debug info:"</span>, debug)
            <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.NULL)
        <span style="color: #0000FF;">elif</span> t != Gst.MessageType.STATE_CHANGED:
            <span style="color: #0000FF;">return</span>
        <span style="color: #0000FF;">if</span> message.parse_state_changed()[1] != Gst.State.PAUSED:
            <span style="color: #0000FF;">return</span>
        <span style="color: #BA36A5;">decoder</span> = <span style="color: #0000FF;">self</span>.player.get_by_name(<span style="color: #008000;">"decoder"</span>)
        <span style="color: #0000FF;">for</span> pad <span style="color: #0000FF;">in</span> decoder.srcpads:
            <span style="color: #BA36A5;">caps</span> = pad.get_current_caps()
            <span style="color: #BA36A5;">structure_name</span> = caps.to_string()
            <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">not</span> structure_name.startswith(<span style="color: #008000;">"video"</span>):
                <span style="color: #0000FF;">continue</span>
            <span style="color: #BA36A5;">width</span> = caps.get_structure(0).get_int(<span style="color: #008000;">"width"</span>)[1]
            <span style="color: #BA36A5;">height</span> = caps.get_structure(0).get_int(<span style="color: #008000;">"height"</span>)[1]
            <span style="color: #0000FF;">if</span> width &gt;= 1e6:
                <span style="color: #0000FF;">continue</span>
            <span style="color: #BA36A5;">resolution_str</span> = <span style="color: #008000;">"Width: {}, Height: {}"</span>.<span style="color: #006FE0;">format</span>(width, height)
            <span style="color: #0000FF;">self</span>.resolution_label.set_text(resolution_str)
            <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.NULL)
            <span style="color: #0000FF;">break</span>

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">decoder_callback</span>(<span style="color: #0000FF;">self</span>, decoder, pad):
        <span style="color: #BA36A5;">structure_name</span> = pad.get_current_caps().to_string()
        <span style="color: #0000FF;">if</span> structure_name.startswith(<span style="color: #008000;">"video"</span>):
            <span style="color: #BA36A5;">fv_pad</span> = <span style="color: #0000FF;">self</span>.fakev.get_static_pad(<span style="color: #008000;">"sink"</span>)
            pad.link(fv_pad)
        <span style="color: #0000FF;">elif</span> structure_name.startswith(<span style="color: #008000;">"audio"</span>):
            <span style="color: #BA36A5;">fa_pad</span> = <span style="color: #0000FF;">self</span>.fakea.get_static_pad(<span style="color: #008000;">"sink"</span>)
            pad.link(fa_pad)


<span style="color: #0000FF;">if</span> <span style="color: #006FE0;">__name__</span> == <span style="color: #008000;">"__main__"</span>:
    Gst.init(sys.argv)
    Gtk.init(sys.argv)
    GTK_Main()
    Gtk.main()
</pre>
</div>

<p>
In the next example we will use the <code>playbin</code> from section <a href="#org4ec0403">3.2</a> and switch its video-sink out for our own homemade bin filled with some elements. Now, let's say that you run a tv-station and you want to have your logo in the top right corner of the screen. For that you can use a <a href="https://gstreamer.freedesktop.org/documentation/pango/textoverlay.html"><code>textoverlay</code></a> but for the fonts to be the exact same size on the screen no matter what kind of resolution the source has you have to specify a width so everything is scaled according to that.
</p>

<a href="capabilities-playbin-example.py">capabilities-playbin-example.py</a>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">!/usr/bin/env python</span>

<span style="color: #0000FF;">import</span> os
<span style="color: #0000FF;">import</span> sys
<span style="color: #0000FF;">import</span> gi

gi.require_version(<span style="color: #008000;">"Gst"</span>, <span style="color: #008000;">"1.0"</span>)
gi.require_version(<span style="color: #008000;">"GstVideo"</span>, <span style="color: #008000;">"1.0"</span>)
gi.require_version(<span style="color: #008000;">"Gtk"</span>, <span style="color: #008000;">"3.0"</span>)

<span style="color: #0000FF;">from</span> gi.repository <span style="color: #0000FF;">import</span> Gst, Gtk      <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">noqa: E402</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Needed for set_window_handle() to work:</span>
<span style="color: #0000FF;">from</span> gi.repository <span style="color: #0000FF;">import</span> GstVideo      <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">noqa: E402, F401</span>


<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">GTK_Main</span>:
    <span style="color: #0000FF;">def</span> <span style="color: #006699;">__init__</span>(<span style="color: #0000FF;">self</span>):
        <span style="color: #BA36A5;">window</span> = Gtk.Window(<span style="color: #006FE0;">type</span>=Gtk.WindowType.TOPLEVEL)
        window.set_title(<span style="color: #008000;">"Video-Player"</span>)
        window.set_default_size(500, 400)
        window.connect(<span style="color: #008000;">"destroy"</span>, Gtk.main_quit, <span style="color: #008000;">"WM destroy"</span>)
        <span style="color: #BA36A5;">vbox</span> = Gtk.VBox()
        window.add(vbox)
        <span style="color: #BA36A5;">hbox</span> = Gtk.HBox()
        vbox.pack_start(hbox, <span style="color: #D0372D;">False</span>, <span style="color: #D0372D;">False</span>, 0)
        <span style="color: #0000FF;">self</span>.entry = Gtk.Entry()
        hbox.add(<span style="color: #0000FF;">self</span>.entry)
        <span style="color: #0000FF;">self</span>.button = Gtk.Button(label=<span style="color: #008000;">"Start"</span>)
        hbox.pack_start(<span style="color: #0000FF;">self</span>.button, <span style="color: #D0372D;">False</span>, <span style="color: #D0372D;">False</span>, 0)
        <span style="color: #0000FF;">self</span>.button.connect(<span style="color: #008000;">"clicked"</span>, <span style="color: #0000FF;">self</span>.start_stop)
        <span style="color: #0000FF;">self</span>.movie_window = Gtk.DrawingArea()
        vbox.add(<span style="color: #0000FF;">self</span>.movie_window)
        window.show_all()

        <span style="color: #0000FF;">self</span>.player = Gst.ElementFactory.make(<span style="color: #008000;">"playbin"</span>, <span style="color: #008000;">"player"</span>)

        <span style="color: #0000FF;">self</span>.<span style="color: #006FE0;">bin</span> = Gst.Bin.new(<span style="color: #008000;">"my-bin"</span>)

        <span style="color: #BA36A5;">videoscale</span> = Gst.ElementFactory.make(<span style="color: #008000;">"videoscale"</span>)
        videoscale.set_property(<span style="color: #008000;">"method"</span>, 1)
        <span style="color: #0000FF;">self</span>.<span style="color: #006FE0;">bin</span>.add(videoscale)
        <span style="color: #BA36A5;">pad</span> = videoscale.get_static_pad(<span style="color: #008000;">"sink"</span>)
        <span style="color: #BA36A5;">ghostpad</span> = Gst.GhostPad.new(<span style="color: #008000;">"sink"</span>, pad)
        <span style="color: #0000FF;">self</span>.<span style="color: #006FE0;">bin</span>.add_pad(ghostpad)

        <span style="color: #BA36A5;">caps</span> = Gst.Caps.from_string(<span style="color: #008000;">"video/x-raw, width=720"</span>)
        <span style="color: #006FE0;">filter</span> = Gst.ElementFactory.make(<span style="color: #008000;">"capsfilter"</span>, <span style="color: #008000;">"filter"</span>)
        <span style="color: #006FE0;">filter</span>.set_property(<span style="color: #008000;">"caps"</span>, caps)
        <span style="color: #0000FF;">self</span>.<span style="color: #006FE0;">bin</span>.add(<span style="color: #006FE0;">filter</span>)
        videoscale.link(<span style="color: #006FE0;">filter</span>)

        <span style="color: #BA36A5;">textoverlay</span> = Gst.ElementFactory.make(<span style="color: #008000;">"textoverlay"</span>)
        textoverlay.set_property(<span style="color: #008000;">"text"</span>, <span style="color: #008000;">"GNUTV"</span>)
        textoverlay.set_property(<span style="color: #008000;">"font-desc"</span>, <span style="color: #008000;">"normal 14"</span>)
        textoverlay.set_property(<span style="color: #008000;">"halignment"</span>, <span style="color: #008000;">"right"</span>)
        textoverlay.set_property(<span style="color: #008000;">"valignment"</span>, <span style="color: #008000;">"top"</span>)
        <span style="color: #0000FF;">self</span>.<span style="color: #006FE0;">bin</span>.add(textoverlay)
        <span style="color: #006FE0;">filter</span>.link(textoverlay)

        <span style="color: #BA36A5;">conv</span> = Gst.ElementFactory.make(<span style="color: #008000;">"videoconvert"</span>, <span style="color: #008000;">"conv"</span>)
        <span style="color: #0000FF;">self</span>.<span style="color: #006FE0;">bin</span>.add(conv)
        textoverlay.link(conv)

        <span style="color: #BA36A5;">videosink</span> = Gst.ElementFactory.make(<span style="color: #008000;">"autovideosink"</span>)
        <span style="color: #0000FF;">self</span>.<span style="color: #006FE0;">bin</span>.add(videosink)
        conv.link(videosink)

        <span style="color: #0000FF;">self</span>.player.set_property(<span style="color: #008000;">"video-sink"</span>, <span style="color: #0000FF;">self</span>.<span style="color: #006FE0;">bin</span>)

        <span style="color: #BA36A5;">bus</span> = <span style="color: #0000FF;">self</span>.player.get_bus()
        bus.add_signal_watch()
        bus.enable_sync_message_emission()
        bus.connect(<span style="color: #008000;">"message"</span>, <span style="color: #0000FF;">self</span>.on_message)
        bus.connect(<span style="color: #008000;">"sync-message::element"</span>, <span style="color: #0000FF;">self</span>.on_sync_message)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">start_stop</span>(<span style="color: #0000FF;">self</span>, w):
        <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">self</span>.button.get_label() == <span style="color: #008000;">"Start"</span>:
            <span style="color: #BA36A5;">filepath</span> = <span style="color: #0000FF;">self</span>.entry.get_text().strip()
            <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">not</span> os.path.isfile(filepath):
                <span style="color: #0000FF;">return</span>
            <span style="color: #BA36A5;">filepath</span> = os.path.realpath(filepath)
            <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Stop"</span>)
            <span style="color: #0000FF;">self</span>.player.set_property(<span style="color: #008000;">"uri"</span>, Gst.filename_to_uri(filepath))
            <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.PLAYING)
        <span style="color: #0000FF;">else</span>:
            <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.NULL)
            <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Start"</span>)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">on_message</span>(<span style="color: #0000FF;">self</span>, bus, message):
        <span style="color: #BA36A5;">t</span> = message.<span style="color: #006FE0;">type</span>
        <span style="color: #0000FF;">if</span> t == Gst.MessageType.ERROR:
            <span style="color: #BA36A5;">error_source</span> = message.src.name
            <span style="color: #BA36A5;">err</span>, <span style="color: #BA36A5;">debug</span> = message.parse_error()
            <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Error from '{}':"</span>.<span style="color: #006FE0;">format</span>(error_source), err.message)
            <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Debug info:"</span>, debug)
        <span style="color: #0000FF;">elif</span> t != Gst.MessageType.EOS:
            <span style="color: #0000FF;">return</span>
        <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.NULL)
        <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Start"</span>)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">on_sync_message</span>(<span style="color: #0000FF;">self</span>, bus, message):
        <span style="color: #BA36A5;">message_name</span> = message.get_structure().get_name()
        <span style="color: #0000FF;">if</span> message_name == <span style="color: #008000;">"prepare-window-handle"</span>:
            <span style="color: #BA36A5;">imagesink</span> = message.src
            imagesink.set_property(<span style="color: #008000;">"force-aspect-ratio"</span>, <span style="color: #D0372D;">True</span>)
            <span style="color: #BA36A5;">window_id</span> = <span style="color: #0000FF;">self</span>.movie_window.get_property(<span style="color: #008000;">"window"</span>).get_xid()
            imagesink.set_window_handle(window_id)


<span style="color: #0000FF;">if</span> <span style="color: #006FE0;">__name__</span> == <span style="color: #008000;">"__main__"</span>:
    Gst.init(sys.argv)
    Gtk.init(sys.argv)
    GTK_Main()
    Gtk.main()
</pre>
</div>
</div>
</div>

<div id="outline-container-orgff284ff" class="outline-2">
<h2 id="orgff284ff"><span class="section-number-2">8</span> Videomixer</h2>
<div class="outline-text-2" id="text-8">
<p>
<a id="org364c73c"></a>
</p>

<p>
The <a href="https://gstreamer.freedesktop.org/documentation/videomixer/index.html"><code>videomixer</code></a> element makes it possible to mix different video streams together. Here is a CLI example:
</p>

<div class="org-src-container">
<pre class="src src-sh">gst-launch-1.0  videotestsrc ! video/x-raw, <span style="color: #BA36A5;">width</span>=320, <span style="color: #BA36A5;">height</span>=240 <span style="color: #008000;">\</span>
                ! videomixer <span style="color: #BA36A5;">name</span>=mix ! videoconvert ! autovideosink <span style="color: #008000;">\</span>
                filesrc <span style="color: #BA36A5;">location</span>=tvlogo.png ! pngdec ! imagefreeze <span style="color: #008000;">\</span>
                ! videobox border-alpha=0 <span style="color: #BA36A5;">alpha</span>=0.5 <span style="color: #BA36A5;">top</span>=-10 <span style="color: #BA36A5;">left</span>=-20 <span style="color: #008000;">\</span>
                ! alphacolor ! mix.
</pre>
</div>

<p>
You have to make a <a href="./tvlogo.png"><code>tvlogo.png</code></a> image (100x100 px) to be able to run it. With the <a href="https://gstreamer.freedesktop.org/documentation/videobox/index.html"><code>videobox</code></a> element you can move the image around and add more alpha channels.
</p>

<p>
In the next example we take the now working Mpeg2-Player from section <a href="#org1c6c7fc">4</a> and add the elements shown above.
</p>

<a href="videomixer-example.py">videomixer-example.py</a>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">!/usr/bin/env python</span>

<span style="color: #0000FF;">import</span> os
<span style="color: #0000FF;">import</span> sys
<span style="color: #0000FF;">import</span> gi

gi.require_version(<span style="color: #008000;">"Gst"</span>, <span style="color: #008000;">"1.0"</span>)
gi.require_version(<span style="color: #008000;">"GstVideo"</span>, <span style="color: #008000;">"1.0"</span>)
gi.require_version(<span style="color: #008000;">"Gtk"</span>, <span style="color: #008000;">"3.0"</span>)

<span style="color: #0000FF;">from</span> gi.repository <span style="color: #0000FF;">import</span> Gst, GLib, Gtk  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">noqa: E402</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Needed for set_window_handle() to work:</span>
<span style="color: #0000FF;">from</span> gi.repository <span style="color: #0000FF;">import</span> GstVideo  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">noqa: E402, F401</span>


<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">GTK_Main</span>:
    <span style="color: #0000FF;">def</span> <span style="color: #006699;">__init__</span>(<span style="color: #0000FF;">self</span>):
        <span style="color: #BA36A5;">window</span> = Gtk.Window(<span style="color: #006FE0;">type</span>=Gtk.WindowType.TOPLEVEL)
        window.set_title(<span style="color: #008000;">"Mpeg2-Player"</span>)
        window.set_default_size(500, 400)
        window.connect(<span style="color: #008000;">"destroy"</span>, Gtk.main_quit, <span style="color: #008000;">"WM destroy"</span>)
        <span style="color: #BA36A5;">vbox</span> = Gtk.VBox()
        window.add(vbox)
        <span style="color: #BA36A5;">hbox</span> = Gtk.HBox()
        vbox.pack_start(hbox, <span style="color: #D0372D;">False</span>, <span style="color: #D0372D;">False</span>, 0)
        <span style="color: #0000FF;">self</span>.entry = Gtk.Entry()
        hbox.add(<span style="color: #0000FF;">self</span>.entry)
        <span style="color: #0000FF;">self</span>.button = Gtk.Button(label=<span style="color: #008000;">"Start"</span>)
        hbox.pack_start(<span style="color: #0000FF;">self</span>.button, <span style="color: #D0372D;">False</span>, <span style="color: #D0372D;">False</span>, 0)
        <span style="color: #0000FF;">self</span>.button.connect(<span style="color: #008000;">"clicked"</span>, <span style="color: #0000FF;">self</span>.start_stop)
        <span style="color: #0000FF;">self</span>.movie_window = Gtk.DrawingArea()
        vbox.add(<span style="color: #0000FF;">self</span>.movie_window)
        window.show_all()

        <span style="color: #0000FF;">self</span>.player = Gst.Pipeline.new(<span style="color: #008000;">"player"</span>)
        <span style="color: #BA36A5;">make_element</span> = Gst.ElementFactory.make
        <span style="color: #BA36A5;">source</span> = make_element(<span style="color: #008000;">"filesrc"</span>, <span style="color: #008000;">"file-source"</span>)
        <span style="color: #BA36A5;">demuxer</span> = make_element(<span style="color: #008000;">"mpegpsdemux"</span>, <span style="color: #008000;">"demuxer"</span>)
        demuxer.connect(<span style="color: #008000;">"pad-added"</span>, <span style="color: #0000FF;">self</span>.demuxer_callback)

        <span style="color: #0000FF;">self</span>.queuea = make_element(<span style="color: #008000;">"queue"</span>, <span style="color: #008000;">"queuea"</span>)
        <span style="color: #BA36A5;">audio_parser</span> = make_element(<span style="color: #008000;">"mpegaudioparse"</span>, <span style="color: #008000;">"audio-parser"</span>)
        <span style="color: #BA36A5;">audio_decoder</span> = make_element(<span style="color: #008000;">"mpg123audiodec"</span>, <span style="color: #008000;">"audio-decoder"</span>)
        <span style="color: #BA36A5;">audioconv</span> = make_element(<span style="color: #008000;">"audioconvert"</span>, <span style="color: #008000;">"converter"</span>)
        <span style="color: #BA36A5;">audiosink</span> = make_element(<span style="color: #008000;">"autoaudiosink"</span>, <span style="color: #008000;">"audio-output"</span>)

        <span style="color: #0000FF;">self</span>.queuev = make_element(<span style="color: #008000;">"queue"</span>, <span style="color: #008000;">"queuev"</span>)
        <span style="color: #BA36A5;">video_parser</span> = make_element(<span style="color: #008000;">"mpegvideoparse"</span>, <span style="color: #008000;">"video-parser"</span>)
        <span style="color: #BA36A5;">video_decoder</span> = make_element(<span style="color: #008000;">"mpeg2dec"</span>, <span style="color: #008000;">"video-decoder"</span>)

        <span style="color: #BA36A5;">png_source</span> = make_element(<span style="color: #008000;">"filesrc"</span>, <span style="color: #008000;">"png-file"</span>)
        png_source.set_property(<span style="color: #008000;">"location"</span>, os.path.realpath(<span style="color: #008000;">"tvlogo.png"</span>))
        <span style="color: #BA36A5;">png_parser</span> = make_element(<span style="color: #008000;">"pngparse"</span>, <span style="color: #008000;">"png-parser"</span>)
        <span style="color: #BA36A5;">png_decoder</span> = make_element(<span style="color: #008000;">"pngdec"</span>, <span style="color: #008000;">"png-decoder"</span>)
        <span style="color: #BA36A5;">imagefreeze</span> = make_element(<span style="color: #008000;">"imagefreeze"</span>, <span style="color: #008000;">"imagefreeze"</span>)
        <span style="color: #BA36A5;">videobox</span> = make_element(<span style="color: #008000;">"videobox"</span>, <span style="color: #008000;">"videobox"</span>)
        videobox.set_property(<span style="color: #008000;">"border-alpha"</span>, 0)
        videobox.set_property(<span style="color: #008000;">"alpha"</span>, 0.5)
        videobox.set_property(<span style="color: #008000;">"left"</span>, -20)
        videobox.set_property(<span style="color: #008000;">"top"</span>, -10)
        <span style="color: #BA36A5;">alphacolor</span> = make_element(<span style="color: #008000;">"alphacolor"</span>, <span style="color: #008000;">"alphacolor"</span>)

        <span style="color: #BA36A5;">mixer</span> = make_element(<span style="color: #008000;">"videomixer"</span>, <span style="color: #008000;">"mixer"</span>)
        <span style="color: #BA36A5;">video_convert</span> = make_element(<span style="color: #008000;">"videoconvert"</span>, <span style="color: #008000;">"video-convert"</span>)
        <span style="color: #BA36A5;">videosink</span> = make_element(<span style="color: #008000;">"autovideosink"</span>, <span style="color: #008000;">"video-output"</span>)

        <span style="color: #0000FF;">for</span> e <span style="color: #0000FF;">in</span> (
            source, demuxer,
            <span style="color: #0000FF;">self</span>.queuea, audio_parser, audio_decoder, audioconv, audiosink,
            <span style="color: #0000FF;">self</span>.queuev, video_parser, video_decoder,
            png_source, png_parser, png_decoder, imagefreeze,
            videobox, alphacolor,
            mixer, video_convert, videosink,
        ):
            <span style="color: #0000FF;">self</span>.player.add(e)

        source.link(demuxer)

        <span style="color: #0000FF;">self</span>.queuev.link(video_parser)
        video_parser.link(video_decoder)
        video_decoder.link(mixer)

        png_source.link(png_parser)
        png_parser.link(png_decoder)
        png_decoder.link(imagefreeze)
        imagefreeze.link(videobox)
        videobox.link(alphacolor)
        alphacolor.link(mixer)

        mixer.link(video_convert)
        video_convert.link(videosink)

        <span style="color: #0000FF;">self</span>.queuea.link(audio_parser)
        audio_parser.link(audio_decoder)
        audio_decoder.link(audioconv)
        audioconv.link(audiosink)

        <span style="color: #BA36A5;">bus</span> = <span style="color: #0000FF;">self</span>.player.get_bus()
        bus.add_signal_watch()
        bus.enable_sync_message_emission()
        bus.connect(<span style="color: #008000;">"message"</span>, <span style="color: #0000FF;">self</span>.on_message)
        bus.connect(<span style="color: #008000;">"sync-message::element"</span>, <span style="color: #0000FF;">self</span>.on_sync_message)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">start_stop</span>(<span style="color: #0000FF;">self</span>, w):
        <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">self</span>.button.get_label() == <span style="color: #008000;">"Start"</span>:
            <span style="color: #BA36A5;">filepath</span> = <span style="color: #0000FF;">self</span>.entry.get_text().strip()
            <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">not</span> os.path.isfile(filepath):
                <span style="color: #0000FF;">return</span>
            <span style="color: #BA36A5;">filepath</span> = os.path.realpath(filepath)
            <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Stop"</span>)
            <span style="color: #BA36A5;">src</span> = <span style="color: #0000FF;">self</span>.player.get_by_name(<span style="color: #008000;">"file-source"</span>)
            src.set_property(<span style="color: #008000;">"location"</span>, filepath)
            <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.PLAYING)
        <span style="color: #0000FF;">else</span>:
            <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.NULL)
            <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Start"</span>)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">on_message</span>(<span style="color: #0000FF;">self</span>, bus, message):
        <span style="color: #BA36A5;">t</span> = message.<span style="color: #006FE0;">type</span>
        <span style="color: #0000FF;">if</span> t == Gst.MessageType.ERROR:
            <span style="color: #BA36A5;">error_source</span> = message.src.name
            <span style="color: #BA36A5;">err</span>, <span style="color: #BA36A5;">debug</span> = message.parse_error()
            <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Error from '{}':"</span>.<span style="color: #006FE0;">format</span>(error_source), err.message)
            <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Debug info:"</span>, debug)
        <span style="color: #0000FF;">elif</span> t != Gst.MessageType.EOS:
            <span style="color: #0000FF;">return</span>
        <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"done"</span>)
        <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.NULL)
        <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Start"</span>)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">on_sync_message</span>(<span style="color: #0000FF;">self</span>, bus, message):
        <span style="color: #BA36A5;">message_name</span> = message.get_structure().get_name()
        <span style="color: #0000FF;">if</span> message_name != <span style="color: #008000;">"prepare-window-handle"</span>:
            <span style="color: #0000FF;">return</span>
        <span style="color: #BA36A5;">imagesink</span> = message.src
        imagesink.set_property(<span style="color: #008000;">"force-aspect-ratio"</span>, <span style="color: #D0372D;">True</span>)
        <span style="color: #BA36A5;">window_id</span> = <span style="color: #0000FF;">self</span>.movie_window.get_property(<span style="color: #008000;">"window"</span>).get_xid()
        imagesink.set_window_handle(window_id)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">demuxer_callback</span>(<span style="color: #0000FF;">self</span>, demuxer, pad):
        <span style="color: #BA36A5;">name_template</span> = pad.get_property(<span style="color: #008000;">"template"</span>).name_template
        <span style="color: #0000FF;">if</span> name_template == <span style="color: #008000;">"video_%02x"</span>:
            pad.link(<span style="color: #0000FF;">self</span>.queuev.get_static_pad(<span style="color: #008000;">"sink"</span>))
        <span style="color: #0000FF;">elif</span> name_template == <span style="color: #008000;">"audio_%02x"</span>:
            pad.link(<span style="color: #0000FF;">self</span>.queuea.get_static_pad(<span style="color: #008000;">"sink"</span>))


<span style="color: #0000FF;">if</span> <span style="color: #006FE0;">__name__</span> == <span style="color: #008000;">"__main__"</span>:
    Gst.init(sys.argv)
    Gtk.init(sys.argv)
    GTK_Main()
    Gtk.main()
</pre>
</div>

<p>
<i>FIXME:</i> playing won't stop at all because <a href="https://gstreamer.freedesktop.org/documentation/imagefreeze/index.html"><code>imagefreeze</code></a> produces infinite stream.
</p>

<p>
Note that image overlay in most cases can be added much easier by replacing <code>imagefreeze</code> and <code>videomixer</code> pair with single <a href="https://gstreamer.freedesktop.org/documentation/gdkpixbuf/gdkpixbufoverlay.html"><code>gdkpixbufoverlay</code></a>. Earlier CLI example can be written as:
</p>

<div class="org-src-container">
<pre class="src src-sh">gst-launch-1.0  videotestsrc ! video/x-raw, <span style="color: #BA36A5;">width</span>=320, <span style="color: #BA36A5;">height</span>=240 <span style="color: #008000;">\</span>
                ! gdkpixbufoverlay <span style="color: #BA36A5;">location</span>=tvlogo.png <span style="color: #008000;">\</span>
                                   <span style="color: #BA36A5;">alpha</span>=0.5 offset-x=20 offset-y=10 <span style="color: #008000;">\</span>
                ! videoconvert ! autovideosink
</pre>
</div>
</div>
</div>


<div id="outline-container-org20414d4" class="outline-2">
<h2 id="org20414d4"><span class="section-number-2">9</span> Webcam Viewer</h2>
<div class="outline-text-2" id="text-9">
<p>
<a id="org470c1f6"></a>
</p>

<p>
Remember to peel the tape off your web cam lens before testing this.
</p>

<a href="webcam-example.py">webcam-example.py</a>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #8D8D84;">#</span><span style="color: #8D8D84; font-style: italic;">!/usr/bin/env python</span>

<span style="color: #0000FF;">import</span> sys
<span style="color: #0000FF;">import</span> gi

gi.require_version(<span style="color: #008000;">"Gst"</span>, <span style="color: #008000;">"1.0"</span>)
gi.require_version(<span style="color: #008000;">"GstVideo"</span>, <span style="color: #008000;">"1.0"</span>)
gi.require_version(<span style="color: #008000;">"Gtk"</span>, <span style="color: #008000;">"3.0"</span>)

<span style="color: #0000FF;">from</span> gi.repository <span style="color: #0000FF;">import</span> Gst, Gtk  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">noqa: E402</span>
<span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Needed for set_window_handle() to work:</span>
<span style="color: #0000FF;">from</span> gi.repository <span style="color: #0000FF;">import</span> GstVideo  <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">noqa: E402, F401</span>


<span style="color: #0000FF;">class</span> <span style="color: #6434A3;">GTK_Main</span>:
    <span style="color: #0000FF;">def</span> <span style="color: #006699;">__init__</span>(<span style="color: #0000FF;">self</span>):
        <span style="color: #BA36A5;">window</span> = Gtk.Window(<span style="color: #006FE0;">type</span>=Gtk.WindowType.TOPLEVEL)
        window.set_title(<span style="color: #008000;">"Webcam-Viewer"</span>)
        window.set_default_size(500, 400)
        window.connect(<span style="color: #008000;">"destroy"</span>, Gtk.main_quit, <span style="color: #008000;">"WM destroy"</span>)
        <span style="color: #BA36A5;">vbox</span> = Gtk.VBox()
        window.add(vbox)
        <span style="color: #0000FF;">self</span>.movie_window = Gtk.DrawingArea()
        vbox.add(<span style="color: #0000FF;">self</span>.movie_window)
        <span style="color: #BA36A5;">hbox</span> = Gtk.HBox()
        vbox.pack_start(hbox, <span style="color: #D0372D;">False</span>, <span style="color: #D0372D;">False</span>, 0)
        hbox.set_border_width(10)
        hbox.pack_start(Gtk.Label(), <span style="color: #D0372D;">False</span>, <span style="color: #D0372D;">False</span>, 0)
        <span style="color: #0000FF;">self</span>.button = Gtk.Button(label=<span style="color: #008000;">"Start"</span>)
        <span style="color: #0000FF;">self</span>.button.connect(<span style="color: #008000;">"clicked"</span>, <span style="color: #0000FF;">self</span>.start_stop)
        hbox.pack_start(<span style="color: #0000FF;">self</span>.button, <span style="color: #D0372D;">False</span>, <span style="color: #D0372D;">False</span>, 0)
        <span style="color: #0000FF;">self</span>.button2 = Gtk.Button(label=<span style="color: #008000;">"Quit"</span>)
        <span style="color: #0000FF;">self</span>.button2.connect(<span style="color: #008000;">"clicked"</span>, Gtk.main_quit)
        hbox.pack_start(<span style="color: #0000FF;">self</span>.button2, <span style="color: #D0372D;">False</span>, <span style="color: #D0372D;">False</span>, 0)
        hbox.add(Gtk.Label())
        window.show_all()

        <span style="color: #8D8D84;"># </span><span style="color: #8D8D84; font-style: italic;">Set up the gstreamer pipeline</span>
        <span style="color: #BA36A5;">pipeline_description</span> = <span style="color: #008000;">"v4l2src ! videoconvert ! autovideosink"</span>
        <span style="color: #0000FF;">self</span>.player = Gst.parse_launch(pipeline_description)
        <span style="color: #BA36A5;">bus</span> = <span style="color: #0000FF;">self</span>.player.get_bus()
        bus.add_signal_watch()
        bus.enable_sync_message_emission()
        bus.connect(<span style="color: #008000;">"message"</span>, <span style="color: #0000FF;">self</span>.on_message)
        bus.connect(<span style="color: #008000;">"sync-message::element"</span>, <span style="color: #0000FF;">self</span>.on_sync_message)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">start_stop</span>(<span style="color: #0000FF;">self</span>, w):
        <span style="color: #0000FF;">if</span> <span style="color: #0000FF;">self</span>.button.get_label() == <span style="color: #008000;">"Start"</span>:
            <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Stop"</span>)
            <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.PLAYING)
        <span style="color: #0000FF;">else</span>:
            <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.NULL)
            <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Start"</span>)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">on_message</span>(<span style="color: #0000FF;">self</span>, bus, message):
        <span style="color: #BA36A5;">t</span> = message.<span style="color: #006FE0;">type</span>
        <span style="color: #0000FF;">if</span> t == Gst.MessageType.ERROR:
            <span style="color: #BA36A5;">error_source</span> = message.src.name
            <span style="color: #BA36A5;">err</span>, <span style="color: #BA36A5;">debug</span> = message.parse_error()
            <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Error from '{}':"</span>.<span style="color: #006FE0;">format</span>(error_source), err.message)
            <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"Debug info:"</span>, debug)
        <span style="color: #0000FF;">elif</span> t != Gst.MessageType.EOS:
            <span style="color: #0000FF;">return</span>
        <span style="color: #0000FF;">print</span>(<span style="color: #008000;">"done"</span>)
        <span style="color: #0000FF;">self</span>.player.set_state(Gst.State.NULL)
        <span style="color: #0000FF;">self</span>.button.set_label(<span style="color: #008000;">"Start"</span>)

    <span style="color: #0000FF;">def</span> <span style="color: #006699;">on_sync_message</span>(<span style="color: #0000FF;">self</span>, bus, message):
        <span style="color: #BA36A5;">message_name</span> = message.get_structure().get_name()
        <span style="color: #0000FF;">if</span> message_name != <span style="color: #008000;">"prepare-window-handle"</span>:
            <span style="color: #0000FF;">return</span>
        <span style="color: #BA36A5;">imagesink</span> = message.src
        imagesink.set_property(<span style="color: #008000;">"force-aspect-ratio"</span>, <span style="color: #D0372D;">True</span>)
        <span style="color: #BA36A5;">window_id</span> = <span style="color: #0000FF;">self</span>.movie_window.get_property(<span style="color: #008000;">"window"</span>).get_xid()
        imagesink.set_window_handle(window_id)


<span style="color: #0000FF;">if</span> <span style="color: #006FE0;">__name__</span> == <span style="color: #008000;">"__main__"</span>:
    Gst.init(sys.argv)
    Gtk.init(sys.argv)
    GTK_Main()
    Gtk.main()
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Jens Persson, Ruben Gonzalez, Brett Viren, Vladislav Glinsky</p>
<p class="date">Created: 2020-12-23 Wed 00:46</p>
<p class="creator"><a href="https://www.gnu.org/software/emacs/">Emacs</a> 27.1 (<a href="https://orgmode.org">Org</a> mode 9.4.4)</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
